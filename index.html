<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NEXUS LIFE OS v9.3</title>
    
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect x='4' y='4' width='56' height='56' rx='18' fill='none' stroke='%2300f0ff' stroke-width='4'/%3E%3Ctext x='50%25' y='55%25' dominant-baseline='middle' text-anchor='middle' font-family='sans-serif' font-weight='bold' fill='%2300f0ff' font-size='28' letter-spacing='-1'%3ENS%3C/text%3E%3C/svg%3E">

    <style>
        :root {
            --bg-core: #0a0a0a;
            --bg-panel: #161616;
            --bg-sidebar: #111111;
            --bg-input: #222222;
            --primary: #00f0ff; 
            --primary-dim: rgba(0, 240, 255, 0.15);
            --accent: #00ff9d; 
            --danger: #ff477e; 
            --gold: #ffd700;   
            --event: #bd00ff;
            --text-main: #f0f0f0;
            --text-muted: #888888;
            --border: #333333;
            --font-stack: 'Segoe UI', 'Roboto', sans-serif;
            --radius-card: 20px;
            --radius-btn: 50px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; }

        body {
            background-color: var(--bg-core);
            color: var(--text-main);
            font-family: var(--font-stack);
            height: 100vh;
            overflow: hidden;
            display: flex;
        }

        /* --- SIDEBAR --- */
        .app-sidebar {
            width: 320px; background: var(--bg-sidebar); border-right: 1px solid var(--border);
            display: flex; flex-direction: column; padding: 2rem 1.5rem; flex-shrink: 0; overflow-y: auto;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); z-index: 2000;
        }
        .sidebar-close-btn { display: none; margin-bottom: 1rem; color: var(--text-muted); background: transparent; border: none; font-size: 1.5rem; cursor: pointer; text-align: right; }

        /* --- CONTENT --- */
        .app-content { flex: 1; padding: 2rem; overflow-y: auto; display: flex; flex-direction: column; align-items: center; position: relative; }
        .content-container { width: 100%; max-width: 800px; padding-bottom: 100px; }

        /* --- HEADER & TABS --- */
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .header-left { display: flex; align-items: center; gap: 1rem; }
        .mobile-toggle-btn { display: none; background: var(--bg-input); border: 1px solid var(--border); color: var(--primary); width: 40px; height: 40px; border-radius: 12px; align-items: center; justify-content: center; cursor: pointer; font-size: 1.2rem; }
        h1 { font-size: 1.4rem; font-weight: 700; display: flex; align-items: center; }
        .logo-icon-header { width: 36px; height: 36px; margin-right: 12px; color: var(--primary); }
        h1 span { color: var(--primary); font-weight: 300; margin-left: 5px; }

        .tab-nav { display: flex; gap: 1rem; margin-bottom: 2rem; border-bottom: 1px solid var(--border); padding-left: 0.5rem; overflow-x: auto; }
        .tab-btn { background: transparent; border: none; color: var(--text-muted); padding: 0.8rem 0.5rem; cursor: pointer; font-size: 0.85rem; font-weight: 700; border-bottom: 2px solid transparent; transition: all 0.2s; white-space: nowrap; text-transform: uppercase; }
        .tab-btn:hover { color: var(--text-main); }
        .tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); }

        /* --- GRIDS & CARDS --- */
        #protocol-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 1.2rem; }
        .card { background: var(--bg-panel); border: 1px solid var(--border); border-radius: var(--radius-card); padding: 1.5rem; display: flex; flex-direction: column; gap: 1.2rem; transition: transform 0.2s; }
        .protocol-name { font-size: 1.15rem; font-weight: 600; color: white; display: flex; align-items: center; gap: 10px; }
        .protocol-icon { background: rgba(255,255,255,0.05); width: 36px; height: 36px; border-radius: 50%; display: flex; justify-content: center; align-items: center; }
        .progress-container { width: 100%; height: 10px; background: var(--bg-core); border-radius: 10px; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, var(--primary), var(--accent)); width: 0%; border-radius: 10px; transition: width 0.5s ease; }
        .progress-fill.complete { background: var(--accent); }
        .stats { display: flex; justify-content: space-between; font-size: 0.85rem; font-weight: 500; }

        /* --- DASHBOARD --- */
        .dashboard-section { margin-top: 3rem; border-top: 1px solid var(--border); padding-top: 2rem; display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem; }
        .dash-card { background: var(--bg-panel); border: 1px solid var(--border); border-radius: var(--radius-card); padding: 1.5rem; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
        .dash-value { font-size: 1.6rem; font-weight: 800; color: white; margin-bottom: 0.5rem; }
        .dash-label { font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; }
        .circular-chart { display: block; margin: 0 auto; max-width: 80%; max-height: 100px; }
        .circle-bg { fill: none; stroke: var(--bg-input); stroke-width: 3.8; }
        .circle { fill: none; stroke-width: 2.8; stroke-linecap: round; animation: progress 1s ease-out forwards; }
        @keyframes progress { 0% { stroke-dasharray: 0 100; } }
        .percentage { fill: #fff; font-family: var(--font-stack); font-weight: bold; font-size: 0.8em; text-anchor: middle; }

        /* --- FINANCE --- */
        .finance-view { display: none; animation: fadeIn 0.3s; }
        .finance-view.active { display: block; }
        .fin-summary { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
        .fin-card.patrimony { border-color: var(--gold); background: rgba(255, 215, 0, 0.05); grid-column: 1 / -1; text-align: center; }
        .fin-card.patrimony .fin-val { color: var(--gold); font-size: 1.8rem; }
        .fin-card { background: var(--bg-panel); border: 1px solid var(--border); border-radius: var(--radius-card); padding: 1.2rem; display: flex; flex-direction: column; justify-content: center; }
        .fin-label { font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 0.5rem; font-weight: 700; }
        .fin-val { font-size: 1.2rem; font-weight: 700; color: white; white-space: nowrap; }
        .fin-val.pos { color: var(--accent); } .fin-val.neg { color: var(--danger); } .fin-val.inv { color: var(--primary); }
        .fin-list { display: flex; flex-direction: column; gap: 0.8rem; }
        .fin-item { background: var(--bg-input); border-radius: 12px; padding: 1rem; display: flex; justify-content: space-between; align-items: center; border-left: 4px solid transparent; }
        .fin-item.income { border-left-color: var(--accent); } .fin-item.expense { border-left-color: var(--danger); } .fin-item.invest { border-left-color: var(--primary); }
        .fin-desc { font-weight: 600; color: var(--text-main); font-size: 0.95rem; } .fin-date { font-size: 0.75rem; color: var(--text-muted); } .fin-amount { font-weight: 700; font-size: 1rem; }

        /* --- SUGGESTIONS --- */
        .suggestions-container { display: none; padding-bottom: 4rem; animation: fadeIn 0.3s; }
        .suggestions-container.active { display: block; }
        .sug-section-title { font-size: 0.9rem; color: var(--text-muted); margin: 2rem 0 1rem 0; text-transform: uppercase; letter-spacing: 1px; font-weight: 700; }
        .sug-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 1rem; }
        .sug-card { aspect-ratio: 1; background: var(--bg-panel); border: 1px solid var(--border); border-radius: var(--radius-card); display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; padding: 1rem; text-align: center; transition: all 0.2s; }
        .sug-card:hover { border-color: var(--primary); transform: translateY(-3px); }
        .sug-icon { font-size: 2.5rem; margin-bottom: 0.8rem; }
        
        /* --- AGENDA & HERO --- */
        .agenda-view { display: none; } .agenda-view.active { display: block; animation: fadeIn 0.3s; }
        .agenda-hero { background: linear-gradient(135deg, rgba(189, 0, 255, 0.1), rgba(10, 10, 10, 0)); border: 1px solid var(--event); border-radius: var(--radius-card); padding: 1.5rem; margin-bottom: 2rem; animation: fadeIn 0.5s; }
        .hero-title { color: var(--event); font-size: 0.8rem; font-weight: 700; letter-spacing: 1px; text-transform: uppercase; margin-bottom: 1rem; display: flex; align-items: center; gap: 8px; }
        .agenda-list { display: flex; flex-direction: column; gap: 0.8rem; }
        .event-card { background: var(--bg-panel); border: 1px solid var(--border); border-radius: 12px; padding: 1rem; display: flex; gap: 1rem; align-items: center; border-left: 4px solid var(--event); }
        .event-time { font-family: monospace; font-size: 1.1rem; color: var(--text-main); font-weight: 700; min-width: 60px; }
        .event-details { flex: 1; } .event-title { font-weight: 600; font-size: 1rem; margin-bottom: 0.2rem; } .event-desc { font-size: 0.8rem; color: var(--text-muted); }
        .event-date-badge { font-size: 0.7rem; background: var(--bg-input); padding: 2px 6px; border-radius: 4px; color: var(--text-muted); margin-left: auto; }

        /* --- INPUTS & CONTROLS --- */
        .input-action-row { display: flex; gap: 0.5rem; margin-top: 0.5rem; }
        .input-fraction { flex: 1; background: var(--bg-input); border: 1px solid var(--border); border-radius: 12px; color: white; padding: 0.8rem; font-size: 1rem; }
        .unit-selector-mini { background: var(--bg-input); color: var(--text-muted); border: 1px solid var(--border); border-radius: 12px; padding: 0 0.5rem; font-size: 0.8rem; font-weight: bold; cursor: pointer; width: 70px; }
        .btn { background: var(--bg-input); border: 1px solid var(--border); color: var(--primary); padding: 0.6rem 1.2rem; cursor: pointer; border-radius: var(--radius-btn); font-size: 0.85rem; font-weight: 600; display: inline-flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .btn-add { background: var(--primary); color: var(--bg-core); border: none; }

        /* Day Selector in Modal */
        .day-selector { display: flex; gap: 5px; justify-content: space-between; margin-bottom: 1rem; }
        .day-checkbox { display: none; }
        .day-label { width: 35px; height: 35px; border-radius: 50%; background: var(--bg-input); border: 1px solid var(--border); display: flex; align-items: center; justify-content: center; font-size: 0.75rem; cursor: pointer; color: var(--text-muted); transition: all 0.2s; }
        .day-checkbox:checked + .day-label { background: var(--primary); color: var(--bg-core); border-color: var(--primary); font-weight: bold; }

        /* --- CALENDAR --- */
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .month-label { font-size: 1.1rem; font-weight: bold; color: white; }
        .month-nav { background: transparent; border: none; color: var(--text-muted); cursor: pointer; font-size: 1.2rem; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; margin-bottom: 2rem; }
        .day-cell { aspect-ratio: 1; display: flex; justify-content: center; align-items: center; font-size: 0.9rem; border-radius: 12px; cursor: pointer; color: var(--text-muted); border: 1px solid transparent; position: relative; }
        .day-cell:hover { background: var(--bg-input); color: white; }
        .day-cell.today { border-color: var(--primary); color: var(--primary); font-weight: bold; }
        .day-cell.selected { background: var(--primary); color: var(--bg-core) !important; font-weight: bold; box-shadow: 0 0 15px var(--primary-dim); border-color: var(--primary); }
        .dot-hist { position: absolute; bottom: 4px; width: 4px; height: 4px; background: var(--accent); border-radius: 50%; left: 50%; transform: translateX(-50%); }
        .dot-event { position: absolute; top: 4px; right: 4px; width: 4px; height: 4px; background: var(--event); border-radius: 50%; }

        /* --- MOBILE --- */
        @media (max-width: 850px) {
            .mobile-toggle-btn { display: flex; } .sidebar-close-btn { display: block; } h1 span { display: none; } h1 { font-size: 1.2rem; }
            .app-sidebar { position: fixed; top: 0; left: 0; width: 85%; height: 100vh; transform: translateX(-100%); box-shadow: 10px 0 50px rgba(0,0,0,0.5); }
            .app-sidebar.active { transform: translateX(0); }
            .sidebar-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1900; display: none; }
            .sidebar-backdrop.active { display: block; }
            .dashboard-section { grid-template-columns: 1fr; }
            .app-content { padding: 1.5rem 1rem; }
            .sug-grid { grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); }
            .fin-summary { grid-template-columns: 1fr 1fr; }
        }

        /* --- MODAL --- */
        #modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); backdrop-filter: blur(8px); display: none; justify-content: center; align-items: center; z-index: 3000; padding: 1rem; }
        .modal { background: var(--bg-panel); border: 1px solid var(--border); border-radius: var(--radius-card); padding: 2rem; width: 100%; max-width: 420px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        .form-control { width: 100%; padding: 0.9rem; background: var(--bg-input); border: 1px solid var(--border); border-radius: 12px; color: white; font-size: 1rem; margin-bottom: 1rem; }
        select.form-control { appearance: none; }
    </style>
</head>
<body>

    <div id="sidebar-backdrop" class="sidebar-backdrop" onclick="nexus.toggleSidebar()"></div>

    <aside class="app-sidebar" id="app-sidebar">
        <button class="sidebar-close-btn" onclick="nexus.toggleSidebar()">‚úï</button>
        <div class="calendar-header">
            <button class="month-nav" onclick="nexus.changeMonth(-1)">‚ùÆ</button>
            <span class="month-label" id="month-label">...</span>
            <button class="month-nav" onclick="nexus.changeMonth(1)">‚ùØ</button>
        </div>
        <div class="calendar-grid">
            <div style="color:var(--text-muted);font-size:0.7rem;text-align:center">D</div><div style="color:var(--text-muted);font-size:0.7rem;text-align:center">S</div><div style="color:var(--text-muted);font-size:0.7rem;text-align:center">T</div><div style="color:var(--text-muted);font-size:0.7rem;text-align:center">Q</div><div style="color:var(--text-muted);font-size:0.7rem;text-align:center">Q</div><div style="color:var(--text-muted);font-size:0.7rem;text-align:center">S</div><div style="color:var(--text-muted);font-size:0.7rem;text-align:center">S</div>
            <div id="calendar-days" style="display: contents;"></div>
        </div>
        <div style="margin-top: auto; padding-top: 1rem; border-top: 1px solid var(--border); text-align: center;">
            <button class="btn" style="width: 100%" onclick="nexus.selectDate(new Date())">VOLTAR PARA HOJE</button>
        </div>
    </aside>

    <main class="app-content">
        <div class="content-container">
            <header>
                <div class="header-left">
                    <button class="mobile-toggle-btn" onclick="nexus.toggleSidebar()">üìÖ</button>
                    <h1>
                        <svg class="logo-icon-header" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg"><rect x="4" y="4" width="56" height="56" rx="18" fill="none" stroke="currentColor" stroke-width="5"/><text x="50%" y="54%" dominant-baseline="middle" text-anchor="middle" font-family="sans-serif" font-weight="800" fill="currentColor" font-size="26" letter-spacing="-1">NS</text></svg>
                        Nexus <span>Life OS</span>
                    </h1>
                </div>
                <button class="btn btn-lang" id="lang-btn" onclick="nexus.toggleLang()">EN</button>
            </header>

            <nav class="tab-nav">
                <button class="tab-btn active" id="tab-protocols" onclick="nexus.switchTab('protocols')">PROTOCOLOS</button>
                <button class="tab-btn" id="tab-agenda" onclick="nexus.switchTab('agenda')">AGENDA</button>
                <button class="tab-btn" id="tab-suggestions" onclick="nexus.switchTab('suggestions')">EXPLORAR</button>
                <button class="tab-btn" id="tab-finance" onclick="nexus.switchTab('finance')">FINAN√áAS</button>
            </nav>

            <h3 id="view-date-label" style="display:none; color:var(--primary); margin-bottom:1rem; border:1px solid var(--primary); padding:5px 10px; border-radius:8px; width:fit-content">...</h3>
            
            <div id="protocol-view">
                <div id="today-agenda-hero" class="agenda-hero" style="display: none;"></div>
                <div id="protocol-grid"></div>
                <section id="dashboard" class="dashboard-section" style="display: none;"></section>
            </div>

            <div id="agenda-view" class="agenda-view"></div>
            <div id="finance-view" class="finance-view"></div>
            <div id="suggestions-view" class="suggestions-container"></div>

            <div id="fab-container" style="text-align: center; margin-top: 2rem;">
                <button class="btn btn-add" style="padding: 0.8rem 2rem; font-size: 1rem;" onclick="nexus.handleFabClick()">+ ADICIONAR</button>
            </div>
        </div>
    </main>

    <div id="modal-overlay"></div>

<script>
/**
 * NEXUS CORE v9.3 (Precision Days & Local Finance)
 */

const UNIT_SYSTEM = {
    groups: {
        time: { label: 'Tempo', units: { 'min': 1, 'h': 60, 'd': 1440 } }, 
        volume: { label: 'Volume', units: { 'ml': 1, 'L': 1000 } }, 
        distance: { label: 'Dist√¢ncia', units: { 'm': 1, 'km': 1000 } }, 
        weight: { label: 'Peso', units: { 'g': 1, 'kg': 1000 } },
        money: { label: 'Moeda', units: { 'R$': 1, 'USD': 1 } },
        generic: { label: 'Geral', units: { 'x': 1, 'p√°g': 1, 'caps': 1 } }
    }
};

const SUGGESTIONS_DB = [
    // Boost - Sa√∫de
    { type: 'boost', icon: 'üíß', name_pt: 'Beber √Ågua', name_en: 'Drink Water', target: 3, unit: 'L', cycle: 'daily' },
    { type: 'boost', icon: 'üí™', name_pt: 'Treino For√ßa', name_en: 'Strength Train', target: 1, unit: 'x', cycle: 'daily' },
    { type: 'boost', icon: 'üèÉ', name_pt: 'Cardio', name_en: 'Cardio', target: 30, unit: 'min', cycle: 'daily' },
    { type: 'boost', icon: 'üò¥', name_pt: 'Sono 8h', name_en: 'Sleep 8h', target: 8, unit: 'h', cycle: 'daily' },
    { type: 'boost', icon: 'üßò', name_pt: 'Medita√ß√£o', name_en: 'Meditation', target: 15, unit: 'min', cycle: 'daily' },
    { type: 'boost', icon: 'üöø', name_pt: 'Banho Gelado', name_en: 'Cold Shower', target: 1, unit: 'x', cycle: 'daily' },
    // Boost - Intelecto
    { type: 'boost', icon: 'üìö', name_pt: 'Leitura', name_en: 'Reading', target: 20, unit: 'pgs', cycle: 'daily' },
    { type: 'boost', icon: 'üíª', name_pt: 'Estudo C√≥digo', name_en: 'Code Study', target: 1, unit: 'h', cycle: 'daily' },
    { type: 'boost', icon: '‚úçÔ∏è', name_pt: 'Di√°rio', name_en: 'Journaling', target: 1, unit: 'x', cycle: 'daily' },
    // Boost - Financeiro
    { type: 'boost', icon: 'üí∞', name_pt: 'Aporte', name_en: 'Investment', target: 500, unit: 'R$', cycle: 'monthly' },
    { type: 'boost', icon: 'üö´', name_pt: 'Dia Zero Gastos', name_en: 'No Spend Day', target: 1, unit: 'd', cycle: 'daily' },
    // Detox
    { type: 'detox', icon: 'üç¨', name_pt: 'Zero A√ß√∫car', name_en: 'No Sugar', target: 1, unit: 'd', cycle: 'daily' },
    { type: 'detox', icon: 'üì±', name_pt: 'Redes Sociais', name_en: 'Social Media', target: 30, unit: 'min', cycle: 'daily' },
    { type: 'detox', icon: 'üéÆ', name_pt: 'Jogos', name_en: 'Gaming', target: 1, unit: 'h', cycle: 'daily' },
    { type: 'detox', icon: 'üç∫', name_pt: 'Sem √Ålcool', name_en: 'No Alcohol', target: 1, unit: 'd', cycle: 'daily' },
    { type: 'detox', icon: 'üö¨', name_pt: 'Sem Fumar', name_en: 'No Smoking', target: 1, unit: 'd', cycle: 'daily' }
];

const DICTIONARY = {
    pt: {
        tabs: { protocols: "PROTOCOLOS", agenda: "AGENDA", finance: "FINAN√áAS", explore: "EXPLORAR" },
        dash: { perf: "PERFORMANCE", streak: "DIAS SEGUIDOS", acts: "A√á√ïES HOJE" },
        fin: { net: "PATRIM√îNIO TOTAL", bal: "SALDO DISPON√çVEL", in: "ENTRADAS", out: "SA√çDAS", inv: "INVESTIDO", desc: "Descri√ß√£o", val: "Valor" },
        agenda: { title: "AGENDA DO DIA", upcoming: "PR√ìXIMOS EVENTOS", desc: "Descri√ß√£o", name: "T√≠tulo" },
        cycles: { daily: "DI√ÅRIO", weekly: "SEMANAL", monthly: "MENSAL", infinite: "ACUMULATIVO" },
        empty: "Sem dados.", emptyFin: "Sem movimenta√ß√µes nesta data.", btnCancel: "Cancelar", btnConfirm: "Confirmar"
    },
    en: {
        tabs: { protocols: "PROTOCOLS", agenda: "AGENDA", finance: "FINANCE", explore: "EXPLORE" },
        dash: { perf: "PERFORMANCE", streak: "STREAK", acts: "ACTIONS" },
        fin: { net: "NET WORTH", bal: "AVAILABLE CASH", in: "INCOME", out: "EXPENSES", inv: "INVESTED", desc: "Description", val: "Amount" },
        agenda: { title: "TODAY'S AGENDA", upcoming: "UPCOMING", desc: "Description", name: "Title" },
        cycles: { daily: "DAILY", weekly: "WEEKLY", monthly: "MONTHLY", infinite: "ACCUMULATIVE" },
        empty: "No data.", emptyFin: "No transactions on this date.", btnCancel: "Cancel", btnConfirm: "Confirm"
    }
};

class NexusOS {
    constructor() {
        this.lang = localStorage.getItem('nexus_lang') || 'pt'; 
        this.protocols = JSON.parse(localStorage.getItem('nexus_protocols')) || [];
        this.history = JSON.parse(localStorage.getItem('nexus_history')) || {}; 
        this.finance = JSON.parse(localStorage.getItem('nexus_finance')) || []; 
        this.agenda = JSON.parse(localStorage.getItem('nexus_agenda')) || []; 
        this.today = new Date(); this.selectedDate = new Date(); this.calendarViewDate = new Date();
        this.currentTab = 'protocols';
        
        this.grid = document.getElementById('protocol-grid');
        this.finView = document.getElementById('finance-view');
        this.agendaView = document.getElementById('agenda-view');
        this.sugView = document.getElementById('suggestions-view');
        this.modalOverlay = document.getElementById('modal-overlay');
        this.init();
    }

    init() {
        this.checkResets(); this.renderCalendar(); this.updateTexts(); this.render(); this.renderSuggestions();
    }

    switchTab(tab) {
        this.currentTab = tab;
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(`tab-${tab}`).classList.add('active');
        document.getElementById('protocol-view').style.display = tab === 'protocols' ? 'block' : 'none';
        this.finView.classList.remove('active'); this.agendaView.classList.remove('active'); this.sugView.classList.remove('active');
        document.getElementById('fab-container').style.display = 'block';
        if(tab === 'protocols') this.render();
        else if(tab === 'agenda') { this.agendaView.classList.add('active'); this.renderAgenda(); }
        else if(tab === 'finance') { this.finView.classList.add('active'); this.renderFinance(); }
        else if(tab === 'suggestions') { this.sugView.classList.add('active'); document.getElementById('fab-container').style.display = 'none'; }
    }

    handleFabClick() {
        if(this.currentTab === 'protocols') this.openProtocolModal();
        else if(this.currentTab === 'finance') this.openFinanceModal();
        else if(this.currentTab === 'agenda') this.openEventModal();
    }

    formatDateKey(date) { const d = new Date(date); return d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0'); }

    checkResets() {
        const now = new Date(); const todayKey = this.formatDateKey(now); let hasChanges = false;
        this.protocols = this.protocols.map(p => {
            const last = new Date(p.lastReset || 0); let reset = false;
            if (p.cycle === 'daily' && todayKey !== this.formatDateKey(last)) reset = true;
            else if (p.cycle === 'weekly' && last < this.getMonday(now)) reset = true;
            else if (p.cycle === 'monthly' && now.getMonth() !== last.getMonth()) reset = true;
            
            // Se for infinito, n√£o reseta o valor, mas atualiza o lastReset para n√£o bugar o calend√°rio
            if (p.cycle === 'infinite') {
                if(todayKey !== this.formatDateKey(last)) {
                     // Salva snapshot para ontem
                     if(p.current > 0) this.archiveHistory(this.formatDateKey(last), p);
                     p.lastReset = now.toISOString(); 
                     hasChanges = true; 
                }
                return p;
            }

            if (reset) { 
                if (p.current > 0) this.archiveHistory(this.formatDateKey(last), p);
                p.current = 0; p.lastReset = now.toISOString(); hasChanges = true; 
            }
            if(!p.lastReset) { p.lastReset = now.toISOString(); hasChanges = true; }
            return p;
        });
        if(hasChanges) this.save();
    }

    archiveHistory(dateKey, p) {
        if (!this.history[dateKey]) this.history[dateKey] = [];
        if (!this.history[dateKey].find(h => h.id === p.id)) {
            this.history[dateKey].push({...p}); 
            localStorage.setItem('nexus_history', JSON.stringify(this.history));
        }
    }

    getMonday(d) { d = new Date(d); const day = d.getDay(); const diff = d.getDate() - day + (day === 0 ? -6 : 1); const m = new Date(d.setDate(diff)); m.setHours(0,0,0,0); return m; }

    // --- RENDER PROTOCOLS (Com filtro de Dias) ---
    render() {
        if(this.currentTab !== 'protocols') return;
        this.grid.innerHTML = '';
        const isToday = this.formatDateKey(this.selectedDate) === this.formatDateKey(this.today);
        const viewKey = this.formatDateKey(this.selectedDate);
        
        document.getElementById('view-date-label').innerText = isToday ? '' : `Visualizando: ${viewKey}`;
        document.getElementById('view-date-label').style.display = isToday ? 'none' : 'block';

        const dayEvents = this.agenda.filter(e => e.date === viewKey).sort((a,b) => a.time.localeCompare(b.time));
        const hero = document.getElementById('today-agenda-hero');
        if (dayEvents.length > 0) {
            hero.style.display = 'block';
            let html = `<div class="hero-title">üìÖ ${this.t('agenda.title')}</div><div class="agenda-list">`;
            dayEvents.forEach(e => {
                html += `<div class="event-card"><div class="event-time">${e.time}</div><div class="event-details"><div class="event-title">${e.title}</div><div class="event-desc">${e.desc}</div></div>${isToday ? `<button style="background:none;border:none;color:var(--text-muted);cursor:pointer" onclick="nexus.deleteEvent('${e.id}')">‚úï</button>`:''}</div>`;
            });
            hero.innerHTML = html + `</div>`;
        } else hero.style.display = 'none';

        // Filter Logic:
        // 1. Data Source (Today vs History)
        // 2. Specific Days Filter (Does this protocol exist on this specific day?)
        const dayOfWeek = this.selectedDate.getDay(); // 0=Sun, 6=Sat
        
        const rawData = isToday ? this.protocols : (this.history[viewKey] || []);
        
        // Aplica filtro de dias espec√≠ficos
        const data = rawData.filter(p => {
            if (!p.days || p.days.length === 0) return true; // Todos os dias
            return p.days.includes(dayOfWeek); // Apenas dias selecionados
        });

        let totalPct = 0; let activeCount = 0;

        if (data.length === 0 && dayEvents.length === 0) {
            this.grid.innerHTML = `<div style="grid-column:1/-1;text-align:center;padding:3rem;color:var(--text-muted);border:2px dashed var(--border);border-radius:20px"><h3>${this.t('empty')}</h3></div>`;
            document.getElementById('dashboard').style.display = 'none';
        } else {
            if(isToday && data.length > 0) document.getElementById('dashboard').style.display = 'grid';
            else document.getElementById('dashboard').style.display = 'none';

            data.forEach(p => {
                const pct = Math.min((p.current / p.target) * 100, 100);
                totalPct += pct; activeCount++;
                const isComp = p.current >= p.target;
                const icon = this.getIcon(p.name);
                const compatibleUnits = this.getCompatibleUnits(p.unit);
                let unitSelectorHTML = '';
                if(isToday && compatibleUnits.length > 1) {
                    unitSelectorHTML = `<select id="unit-sel-${p.id}" class="unit-selector-mini">`;
                    compatibleUnits.forEach(u => unitSelectorHTML += `<option value="${u}" ${u===p.unit?'selected':''}>${u}</option>`);
                    unitSelectorHTML += `</select>`;
                } else unitSelectorHTML = `<span class="unit-selector-mini" style="border:none;padding-top:4px">${p.unit}</span>`;
                
                const inputArea = isToday ? `<div class="input-action-row"><input type="number" class="input-fraction" id="input-${p.id}" placeholder="0" onkeydown="if(event.key==='Enter')nexus.handleInput('${p.id}')">${unitSelectorHTML}<button class="btn" onclick="nexus.handleInput('${p.id}')">+</button></div>` : '';
                const card = document.createElement('div'); card.className = `card ${!isToday?'read-only':''}`;
                card.innerHTML = `<div style="display:flex;justify-content:space-between"><div class="protocol-name"><span class="protocol-icon">${icon}</span> ${p.name}</div>${isToday ? `<button style="background:none;border:none;color:#555;cursor:pointer" onclick="nexus.deleteProtocol('${p.id}')">‚úï</button>` : ''}</div><div class="stats"><span style="color:${isComp?'var(--accent)':'var(--text-main)'}">${p.current} / ${p.target} ${p.unit}</span><span>${pct.toFixed(0)}%</span></div><div class="progress-container"><div class="progress-fill ${isComp?'complete':''}" style="width:${pct}%"></div></div>${inputArea}`;
                this.grid.appendChild(card);
            });
            if(isToday && activeCount > 0) this.renderDashboard(totalPct, activeCount);
        }
    }

    // --- RENDER FINANCE (Hybrid Logic) ---
    renderFinance() {
        // Parte 1: Totais Globais (Sempre Atuais)
        let bal = 0, inv = 0;
        this.finance.forEach(t => {
            const val = parseFloat(t.amount);
            if(t.type === 'in') bal += val;
            else if(t.type === 'out') bal -= val;
            else if(t.type === 'inv') { bal -= val; inv += val; }
        });
        const netWorth = bal + inv;

        // Parte 2: Lista de Transa√ß√µes (Filtrada pela Data Selecionada)
        const viewKey = this.formatDateKey(this.selectedDate);
        const dailyTransactions = this.finance.filter(t => t.date.startsWith(viewKey)).reverse();
        
        let incDay = 0, expDay = 0;
        let listHTML = '';
        
        dailyTransactions.forEach(t => {
             const val = parseFloat(t.amount);
             if(t.type === 'in') incDay += val;
             else if(t.type === 'out') expDay += val;
             
             const typeClass = t.type === 'in' ? 'income' : (t.type === 'out' ? 'expense' : 'invest');
             const sign = t.type === 'in' ? '+' : '-';
             const color = t.type === 'in' ? 'var(--accent)' : (t.type === 'out' ? 'var(--danger)' : 'var(--primary)');
             listHTML += `<div class="fin-item ${typeClass}"><div><div class="fin-desc">${t.desc}</div><div class="fin-date">${t.time || ''}</div></div><div class="fin-amount" style="color:${color}">${sign} ${val.toLocaleString('pt-BR', {style:'currency', currency:'BRL'})}</div></div>`;
        });

        const isToday = this.formatDateKey(this.selectedDate) === this.formatDateKey(this.today);
        const dateLabel = isToday ? "HOJE" : viewKey;

        this.finView.innerHTML = `
            <div class="fin-summary">
                <div class="fin-card patrimony"><div class="fin-label">${this.t('fin.net')} (TOTAL)</div><div class="fin-val">${netWorth.toLocaleString('pt-BR', {style:'currency', currency:'BRL'})}</div></div>
                <div class="fin-card"><div class="fin-label">${this.t('fin.bal')} (CAIXA)</div><div class="fin-val">${bal.toLocaleString('pt-BR', {style:'currency', currency:'BRL'})}</div></div>
                <div class="fin-card"><div class="fin-label">${this.t('fin.inv')} (ACUMULADO)</div><div class="fin-val inv">${inv.toLocaleString('pt-BR', {style:'currency', currency:'BRL'})}</div></div>
            </div>
            
            <div style="margin-bottom:1rem; padding-bottom:0.5rem; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center">
                <span style="font-size:0.9rem; font-weight:bold; color:var(--text-main)">Transa√ß√µes de ${dateLabel}</span>
                <span style="font-size:0.8rem; color:var(--text-muted)">Entrada: +${incDay} | Sa√≠da: -${expDay}</span>
            </div>

            <div class="fin-list">${listHTML || `<div style="text-align:center;color:#666;padding:2rem">${this.t('emptyFin')}</div>`}</div>
        `;
    }

    // --- RENDER AGENDA & SUGGESTIONS ---
    renderAgenda() {
        const sorted = this.agenda.sort((a,b) => new Date(a.date + 'T' + a.time) - new Date(b.date + 'T' + b.time));
        const upcoming = sorted.filter(e => e.date >= this.formatDateKey(this.today));
        let html = `<div style="margin-bottom:1.5rem; color:var(--text-muted)">${this.t('agenda.upcoming')}</div>`;
        if (upcoming.length === 0) html += `<div style="text-align:center;color:#666">Nenhum evento futuro.</div>`;
        else {
            html += `<div class="agenda-list">`;
            upcoming.forEach(e => {
                const dateObj = new Date(e.date + 'T12:00:00');
                html += `<div class="event-card"><div class="event-time">${e.time}</div><div class="event-details"><div class="event-title">${e.title}</div><div class="event-desc">${e.desc}</div></div><div class="event-date-badge">${dateObj.getDate()}/${dateObj.getMonth()+1}</div><button style="background:none;border:none;color:var(--text-muted);cursor:pointer;margin-left:10px" onclick="nexus.deleteEvent('${e.id}')">‚úï</button></div>`;
            });
            html += `</div>`;
        }
        this.agendaView.innerHTML = html;
    }

    renderSuggestions() {
        this.sugView.innerHTML = '';
        const renderSection = (type, titleKey) => {
            const items = SUGGESTIONS_DB.filter(s => s.type === type);
            if(items.length === 0) return '';
            let html = `<div class="sug-section-title">${this.t(titleKey)}</div><div class="sug-grid">`;
            items.forEach(item => {
                const name = this.lang === 'pt' ? item.name_pt : item.name_en;
                html += `<div class="sug-card" onclick="nexus.openProtocolModal({name: '${name}', target: ${item.target}, unit: '${item.unit}', cycle: '${item.cycle}'})"><div class="sug-icon">${item.icon}</div><div class="sug-name">${name}</div><div class="sug-meta">${item.target} ${item.unit}</div></div>`;
            });
            return html + `</div>`;
        };
        this.sugView.innerHTML += renderSection('boost', 'sections.boost');
        this.sugView.innerHTML += renderSection('detox', 'sections.detox');
    }

    // --- MODALS WITH DAY SELECTOR ---
    openProtocolModal(pre={}) {
        let optionsHTML = '';
        for(const key in UNIT_SYSTEM.groups) {
            const g = UNIT_SYSTEM.groups[key];
            optionsHTML += `<optgroup label="${g.label}">`;
            for(const u in g.units) optionsHTML += `<option value="${u}" ${pre.unit===u?'selected':''}>${u}</option>`;
            optionsHTML += `</optgroup>`;
        }
        
        // Checkboxes Dias da Semana
        const daysHTML = `
            <div class="day-selector">
                ${['D','S','T','Q','Q','S','S'].map((d, i) => `
                    <label>
                        <input type="checkbox" class="day-checkbox" value="${i}" checked>
                        <span class="day-label">${d}</span>
                    </label>
                `).join('')}
            </div>
        `;

        const html = `
            <div class="modal">
                <h2 style="color:var(--primary);margin-bottom:1.5rem">Novo Protocolo</h2>
                <input type="text" id="p-name" class="form-control" placeholder="Nome" value="${pre.name||''}">
                <div style="display:flex;gap:1rem">
                    <input type="number" id="p-target" class="form-control" placeholder="Meta" value="${pre.target||''}">