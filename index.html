<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NEXUS LIFE OS v11.1</title>
    
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect x='4' y='4' width='56' height='56' rx='18' fill='none' stroke='%2300f0ff' stroke-width='4'/%3E%3Ctext x='50%25' y='55%25' dominant-baseline='middle' text-anchor='middle' font-family='sans-serif' font-weight='bold' fill='%2300f0ff' font-size='28' letter-spacing='-1'%3ENS%3C/text%3E%3C/svg%3E">

    <style>
        :root {
            --bg-core: #0a0a0a; --bg-panel: #161616; --bg-sidebar: #111111; --bg-input: #222222;
            --primary: #00f0ff; --primary-dim: rgba(0, 240, 255, 0.15); --accent: #00ff9d; --danger: #ff477e;
            --gold: #ffd700; --event: #bd00ff; --global: #9d00ff; --text-main: #f0f0f0; --text-muted: #888888;
            --border: #333333; --font-stack: 'Segoe UI', 'Roboto', sans-serif; --radius-card: 20px; --radius-btn: 50px;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--bg-core); color: var(--text-main); font-family: var(--font-stack); height: 100vh; overflow: hidden; display: flex; }

        /* --- SIDEBAR & LAYOUT --- */
        .app-sidebar { width: 340px; background: var(--bg-sidebar); border-right: 1px solid var(--border); display: flex; flex-direction: column; padding: 1.5rem; flex-shrink: 0; overflow-y: auto; transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); z-index: 2000; height: 100vh; }
        .sidebar-close-btn { display: none; margin-bottom: 1rem; color: var(--text-muted); background: transparent; border: none; font-size: 1.5rem; cursor: pointer; text-align: right; }
        .app-content { flex: 1; padding: 2rem; overflow-y: auto; display: flex; flex-direction: column; align-items: center; position: relative; }
        .content-container { width: 100%; max-width: 900px; padding-bottom: 100px; }
        
        /* --- HEADER --- */
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .header-left { display: flex; align-items: center; gap: 1rem; }
        .mobile-toggle-btn { display: none; background: var(--bg-input); border: 1px solid var(--border); color: var(--primary); width: 40px; height: 40px; border-radius: 12px; align-items: center; justify-content: center; cursor: pointer; font-size: 1.2rem; }
        h1 { font-size: 1.4rem; font-weight: 700; display: flex; align-items: center; }
        .logo-icon-header { width: 36px; height: 36px; margin-right: 12px; color: var(--primary); }
        h1 span { color: var(--primary); font-weight: 300; margin-left: 5px; }
        .tab-nav { display: flex; gap: 1rem; margin-bottom: 2rem; border-bottom: 1px solid var(--border); padding-left: 0.5rem; overflow-x: auto; }
        .tab-btn { background: transparent; border: none; color: var(--text-muted); padding: 0.8rem 0.5rem; cursor: pointer; font-size: 0.85rem; font-weight: 700; border-bottom: 2px solid transparent; transition: all 0.2s; white-space: nowrap; text-transform: uppercase; }
        .tab-btn:hover { color: var(--text-main); }
        .tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); }

        /* --- CALENDAR --- */
        .calendar-container { margin-bottom: 2rem; }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .month-label { font-size: 1rem; font-weight: bold; color: white; }
        .month-nav { background: transparent; border: none; color: var(--text-muted); cursor: pointer; font-size: 1.2rem; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; }
        .day-cell { aspect-ratio: 1; display: flex; justify-content: center; align-items: center; font-size: 0.85rem; border-radius: 10px; cursor: pointer; color: var(--text-muted); border: 1px solid transparent; position: relative; }
        .day-cell:hover { background: var(--bg-input); color: white; }
        .day-cell.today { border-color: var(--primary); color: var(--primary); font-weight: bold; }
        .day-cell.selected { background: var(--primary); color: var(--bg-core) !important; font-weight: bold; box-shadow: 0 0 15px var(--primary-dim); border-color: var(--primary); }
        .dot-hist { position: absolute; bottom: 3px; width: 3px; height: 3px; background: var(--accent); border-radius: 50%; left: 50%; transform: translateX(-50%); }
        .dot-event { position: absolute; top: 3px; right: 3px; width: 3px; height: 3px; background: var(--event); border-radius: 50%; }

        /* --- SIDEBAR AGENDA --- */
        .sidebar-agenda { border-top: 1px solid var(--border); padding-top: 1.5rem; flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .sidebar-agenda-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .agenda-title { font-size: 0.9rem; font-weight: 700; color: var(--event); letter-spacing: 1px; text-transform: uppercase; }
        .btn-mini-add { background: var(--bg-input); color: var(--event); border: 1px solid var(--border); width: 24px; height: 24px; border-radius: 50%; display: flex; justify-content: center; align-items: center; cursor: pointer; font-size: 1rem; }
        .sidebar-event-list { overflow-y: auto; flex: 1; padding-right: 5px; }
        .side-event-card { background: var(--bg-input); border-radius: 10px; padding: 0.8rem; margin-bottom: 0.8rem; border-left: 3px solid var(--event); position: relative; }
        .side-event-time { font-size: 0.75rem; color: var(--event); font-weight: 700; margin-bottom: 2px; }
        .side-event-title { font-size: 0.9rem; font-weight: 600; color: white; }
        .side-event-desc { font-size: 0.75rem; color: var(--text-muted); margin-top: 2px; }
        .btn-del-item { position: absolute; bottom: 0.5rem; right: 0.5rem; background: none; border: none; color: #444; cursor: pointer; font-size: 0.8rem; transition: color 0.2s; }
        .btn-del-item:hover { color: var(--danger); }

        /* --- GRIDS --- */
        #protocol-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 1.2rem; }
        .card { background: var(--bg-panel); border: 1px solid var(--border); border-radius: var(--radius-card); padding: 1.5rem; display: flex; flex-direction: column; gap: 1.2rem; transition: transform 0.2s; }
        .protocol-name { font-size: 1.15rem; font-weight: 600; color: white; display: flex; align-items: center; gap: 10px; }
        .protocol-icon { background: rgba(255,255,255,0.05); width: 36px; height: 36px; border-radius: 50%; display: flex; justify-content: center; align-items: center; }
        .progress-container { width: 100%; height: 10px; background: var(--bg-core); border-radius: 10px; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, var(--primary), var(--accent)); width: 0%; border-radius: 10px; transition: width 0.5s ease; }
        .progress-fill.complete { background: var(--accent); }
        .stats { display: flex; justify-content: space-between; font-size: 0.85rem; font-weight: 500; }
        .dashboard-section { margin-top: 3rem; border-top: 1px solid var(--border); padding-top: 2rem; display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem; }
        .dash-card { background: var(--bg-panel); border: 1px solid var(--border); border-radius: var(--radius-card); padding: 1.5rem; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
        .dash-value { font-size: 1.6rem; font-weight: 800; color: white; margin-bottom: 0.5rem; }
        .dash-label { font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; }
        .circular-chart { display: block; margin: 0 auto; max-width: 80%; max-height: 100px; }
        .circle-bg { fill: none; stroke: var(--bg-input); stroke-width: 3.8; }
        .circle { fill: none; stroke-width: 2.8; stroke-linecap: round; animation: progress 1s ease-out forwards; }
        @keyframes progress { 0% { stroke-dasharray: 0 100; } }
        .percentage { fill: #fff; font-family: var(--font-stack); font-weight: bold; font-size: 0.8em; text-anchor: middle; }

        /* --- FINANCES --- */
        .finance-view { display: none; animation: fadeIn 0.3s; }
        .finance-view.active { display: block; }
        .fin-summary { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
        .fin-card.patrimony { border-color: var(--gold); background: rgba(255, 215, 0, 0.05); grid-column: 1 / -1; text-align: center; }
        .fin-card.patrimony .fin-val { color: var(--gold); font-size: 1.8rem; }
        .fin-card.global-net { border-color: var(--global); background: rgba(157, 0, 255, 0.05); grid-column: 1 / -1; text-align: center; }
        .fin-card.global-net .fin-val { color: var(--global); font-size: 2rem; text-shadow: 0 0 15px rgba(157, 0, 255, 0.3); }
        .fin-card { background: var(--bg-panel); border: 1px solid var(--border); border-radius: var(--radius-card); padding: 1.2rem; display: flex; flex-direction: column; justify-content: center; }
        .fin-label { font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 0.5rem; font-weight: 700; }
        .fin-val { font-size: 1.2rem; font-weight: 700; color: white; white-space: nowrap; }
        .fin-val.pos { color: var(--accent); } .fin-val.neg { color: var(--danger); } .fin-val.inv { color: var(--primary); } .fin-val.glo { color: var(--global); }
        .fin-list { display: flex; flex-direction: column; gap: 0.8rem; }
        .fin-item { background: var(--bg-input); border-radius: 12px; padding: 1rem; display: flex; justify-content: space-between; align-items: center; border-left: 4px solid transparent; position: relative; }
        .fin-item.income { border-left-color: var(--accent); } .fin-item.expense { border-left-color: var(--danger); } .fin-item.invest { border-left-color: var(--primary); }
        .fin-desc { font-weight: 600; color: var(--text-main); font-size: 0.95rem; } .fin-date { font-size: 0.75rem; color: var(--text-muted); } .fin-amount { font-weight: 700; font-size: 1rem; }
        .fin-del-btn { background: none; border: none; color: #555; cursor: pointer; font-size: 1.1rem; margin-left: 1rem; transition: color 0.2s; }
        .fin-del-btn:hover { color: var(--danger); }
        
        /* CHART FIX */
        .fin-chart-container { margin-bottom: 2rem; background: var(--bg-panel); border-radius: var(--radius-card); padding: 1.5rem; border: 1px solid var(--border); display:block; }
        .chart-row { margin-bottom: 0.8rem; }
        .chart-header { display: flex; justify-content: space-between; font-size: 0.85rem; margin-bottom: 0.4rem; color: var(--text-main); font-weight: 600; }
        .chart-bar-bg { width: 100%; height: 8px; background: var(--bg-input); border-radius: 4px; overflow: hidden; }
        .chart-bar-fill { height: 100%; background: var(--danger); border-radius: 4px; transition: width 0.5s; }

        /* --- CURRENCY --- */
        .currency-view { display: none; animation: fadeIn 0.3s; }
        .currency-view.active { display: block; }
        .currency-card { background: var(--bg-panel); border: 1px solid var(--border); border-radius: var(--radius-card); padding: 2rem; display: flex; flex-direction: column; align-items: center; gap: 1.5rem; max-width: 500px; margin: 0 auto; text-align: center; margin-bottom: 2rem; }
        .curr-input-group { width: 100%; display: flex; flex-direction: column; gap: 0.5rem; text-align: left; }
        .curr-label { font-size: 0.85rem; color: var(--text-muted); font-weight: 600; }
        .curr-result { font-size: 2rem; font-weight: 800; color: var(--primary); margin-top: 1rem; }
        .curr-rate-info { font-size: 0.8rem; color: var(--text-muted); margin-top: 0.5rem; }
        .wallet-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; width: 100%; max-width: 500px; margin: 0 auto; }
        .wallet-item { background: var(--bg-panel); border: 1px solid var(--border); border-radius: 12px; padding: 1rem; display: flex; flex-direction: column; gap: 0.5rem; }
        .wallet-label { color: var(--global); font-weight: bold; font-size: 0.9rem; }
        .wallet-input { background: var(--bg-input); border: 1px solid var(--border); color: white; padding: 0.5rem; border-radius: 8px; font-size: 1rem; width: 100%; }
        .btn-add-wallet { display: none; margin-top: 1rem; background: var(--global); color: white; width: 100%; padding: 0.8rem; border-radius: 50px; border: none; font-weight: bold; cursor: pointer; animation: fadeIn 0.5s; }
        .btn-add-wallet:hover { opacity: 0.9; }

        /* --- SUGGESTIONS & MISC --- */
        .suggestions-container { display: none; padding-bottom: 4rem; animation: fadeIn 0.3s; }
        .suggestions-container.active { display: block; }
        .sug-section-title { font-size: 0.9rem; color: var(--text-muted); margin: 2rem 0 1rem 0; text-transform: uppercase; letter-spacing: 1px; font-weight: 700; }
        .sug-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 1rem; }
        .sug-card { aspect-ratio: 1; background: var(--bg-panel); border: 1px solid var(--border); border-radius: var(--radius-card); display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; padding: 1rem; text-align: center; transition: all 0.2s; }
        .sug-card:hover { border-color: var(--primary); transform: translateY(-3px); }
        .sug-icon { font-size: 2.5rem; margin-bottom: 0.8rem; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .input-action-row { display: flex; gap: 0.5rem; margin-top: 0.5rem; }
        .input-fraction { flex: 1; background: var(--bg-input); border: 1px solid var(--border); border-radius: 12px; color: white; padding: 0.8rem; font-size: 1rem; }
        .unit-selector-mini { background: var(--bg-input); color: var(--text-muted); border: 1px solid var(--border); border-radius: 12px; padding: 0 0.5rem; font-size: 0.8rem; font-weight: bold; cursor: pointer; width: 70px; }
        .btn { background: var(--bg-input); border: 1px solid var(--border); color: var(--primary); padding: 0.6rem 1.2rem; cursor: pointer; border-radius: var(--radius-btn); font-size: 0.85rem; font-weight: 600; display: inline-flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .btn-add { background: var(--primary); color: var(--bg-core); border: none; }
        
        .day-selector { display: flex; gap: 5px; justify-content: space-between; margin-bottom: 1rem; }
        .day-checkbox { display: none; }
        .day-label { width: 35px; height: 35px; border-radius: 50%; background: var(--bg-input); border: 1px solid var(--border); display: flex; align-items: center; justify-content: center; font-size: 0.75rem; cursor: pointer; color: var(--text-muted); transition: all 0.2s; }
        .day-checkbox:checked + .day-label { background: var(--primary); color: var(--bg-core); border-color: var(--primary); font-weight: bold; }

        @media (max-width: 850px) {
            .mobile-toggle-btn { display: flex; } .sidebar-close-btn { display: block; } h1 span { display: none; } h1 { font-size: 1.2rem; }
            .app-sidebar { position: fixed; top: 0; left: 0; width: 85%; height: 100vh; transform: translateX(-100%); box-shadow: 10px 0 50px rgba(0,0,0,0.5); border-right: none; }
            .app-sidebar.active { transform: translateX(0); }
            .sidebar-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1900; display: none; }
            .sidebar-backdrop.active { display: block; }
            .dashboard-section { grid-template-columns: 1fr; }
            .app-content { padding: 1.5rem 1rem; }
            .sug-grid { grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); }
            .fin-summary { grid-template-columns: 1fr 1fr; }
        }

        #modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); backdrop-filter: blur(8px); display: none; justify-content: center; align-items: center; z-index: 3000; padding: 1rem; }
        .modal { background: var(--bg-panel); border: 1px solid var(--border); border-radius: var(--radius-card); padding: 2rem; width: 100%; max-width: 420px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        .form-control { width: 100%; padding: 0.9rem; background: var(--bg-input); border: 1px solid var(--border); border-radius: 12px; color: white; font-size: 1rem; margin-bottom: 1rem; }
        select.form-control { appearance: none; }

        /* Login */
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-core); z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 2rem; }
        .login-card { background: var(--bg-panel); border: 1px solid var(--border); padding: 3rem; border-radius: 30px; text-align: center; width: 100%; max-width: 400px; box-shadow: 0 0 50px rgba(0,240,255,0.1); }
        .btn-login-google { background: white; color: #333; width: 100%; padding: 1rem; border-radius: 50px; border: none; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; margin-top: 2rem; transition: transform 0.2s; }
        .btn-login-google:hover { transform: scale(1.02); }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-card">
            <svg style="width:64px;height:64px;color:var(--primary);margin-bottom:1rem" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg"><rect x="4" y="4" width="56" height="56" rx="18" fill="none" stroke="currentColor" stroke-width="5"/><text x="50%" y="54%" dominant-baseline="middle" text-anchor="middle" font-family="sans-serif" font-weight="800" fill="currentColor" font-size="26" letter-spacing="-1">NS</text></svg>
            <h1 style="justify-content:center; margin-bottom:0.5rem">Nexus Life OS</h1>
            <p style="color:var(--text-muted)">Sincroniza√ß√£o em Nuvem</p>
            <button class="btn-login-google" onclick="nexus.loginGoogle()">
                <svg width="20" height="20" viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>
                Entrar com Google
            </button>
            <div id="login-status" style="margin-top:1rem;color:var(--primary);font-size:0.8rem"></div>
        </div>
    </div>

    <div id="app-container" style="display:none; width:100%; height:100%; display:flex;">
        <div id="sidebar-backdrop" class="sidebar-backdrop" onclick="nexus.toggleSidebar()"></div>

        <aside class="app-sidebar" id="app-sidebar">
            <button class="sidebar-close-btn" onclick="nexus.toggleSidebar()">‚úï</button>
            <div class="calendar-container">
                <div class="calendar-header">
                    <button class="month-nav" onclick="nexus.changeMonth(-1)">‚ùÆ</button>
                    <span class="month-label" id="month-label">...</span>
                    <button class="month-nav" onclick="nexus.changeMonth(1)">‚ùØ</button>
                </div>
                <div class="calendar-grid">
                    <div style="color:var(--text-muted);font-size:0.7rem;text-align:center">D</div><div style="color:var(--text-muted);font-size:0.7rem;text-align:center">S</div><div style="color:var(--text-muted);font-size:0.7rem;text-align:center">T</div><div style="color:var(--text-muted);font-size:0.7rem;text-align:center">Q</div><div style="color:var(--text-muted);font-size:0.7rem;text-align:center">Q</div><div style="color:var(--text-muted);font-size:0.7rem;text-align:center">S</div><div style="color:var(--text-muted);font-size:0.7rem;text-align:center">S</div>
                    <div id="calendar-days" style="display: contents;"></div>
                </div>
            </div>
            <div class="sidebar-agenda">
                <div class="sidebar-agenda-header">
                    <div class="agenda-title">üìÖ Eventos</div>
                    <button class="btn-mini-add" onclick="nexus.openEventModal()" title="Novo Evento">+</button>
                </div>
                <div id="sidebar-event-list" class="sidebar-event-list"></div>
            </div>
            <div style="margin-top: auto; padding-top: 1rem; border-top: 1px solid var(--border); text-align: center;">
                <button class="btn" style="width: 100%" onclick="nexus.selectDate(new Date())">VOLTAR PARA HOJE</button>
                <button class="btn" style="width: 100%; margin-top:10px; border-color:var(--danger); color:var(--danger)" onclick="nexus.logout()">SAIR</button>
            </div>
        </aside>

        <main class="app-content">
            <div class="content-container">
                <header>
                    <div class="header-left">
                        <button class="mobile-toggle-btn" onclick="nexus.toggleSidebar()">üìÖ</button>
                        <h1>
                            <svg class="logo-icon-header" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg"><rect x="4" y="4" width="56" height="56" rx="18" fill="none" stroke="currentColor" stroke-width="5"/><text x="50%" y="54%" dominant-baseline="middle" text-anchor="middle" font-family="sans-serif" font-weight="800" fill="currentColor" font-size="26" letter-spacing="-1">NS</text></svg>
                            Nexus <span>Life OS</span>
                        </h1>
                    </div>
                    <div style="display:flex; gap:10px; align-items:center">
                        <span id="user-display" style="font-size:0.8rem; color:var(--text-muted)"></span>
                        <button class="btn btn-lang" id="lang-btn" onclick="nexus.toggleLang()">EN</button>
                    </div>
                </header>

                <nav class="tab-nav">
                    <button class="tab-btn active" id="tab-protocols" onclick="nexus.switchTab('protocols')">PROTOCOLOS</button>
                    <button class="tab-btn" id="tab-suggestions" onclick="nexus.switchTab('suggestions')">EXPLORAR</button>
                    <button class="tab-btn" id="tab-finance" onclick="nexus.switchTab('finance')">FINAN√áAS</button>
                    <button class="tab-btn" id="tab-currency" onclick="nexus.switchTab('currency')">C√ÇMBIO</button>
                </nav>

                <h3 id="view-date-label" style="display:none; color:var(--primary); margin-bottom:1rem; border:1px solid var(--primary); padding:5px 10px; border-radius:8px; width:fit-content">...</h3>
                
                <div id="protocol-view">
                    <div id="protocol-grid"></div>
                    <section id="dashboard" class="dashboard-section" style="display: none;"></section>
                </div>

                <div id="finance-view" class="finance-view"></div>
                
                <div id="currency-view" class="currency-view">
                    <div class="currency-card">
                        <h2 style="color:var(--primary)">Conversor de Moedas</h2>
                        <div class="curr-input-group">
                            <label class="curr-label">Valor em Reais (BRL)</label>
                            <input type="number" id="brl-input" class="form-control" placeholder="0,00" style="font-size:1.2rem; font-weight:bold;">
                        </div>
                        <div class="curr-input-group">
                            <label class="curr-label">Converter para</label>
                            <select id="target-currency" class="form-control" style="font-size:1rem;">
                                <option value="USD">D√≥lar Americano (USD)</option>
                                <option value="EUR">Euro (EUR)</option>
                                <option value="GBP">Libra Esterlina (GBP)</option>
                                <option value="BTC">Bitcoin (BTC)</option>
                            </select>
                        </div>
                        <button class="btn btn-add" style="width:100%; padding:1rem; font-size:1.1rem" onclick="nexus.convertCurrency()">CONVERTER AGORA</button>
                        <div>
                            <div id="conversion-result" class="curr-result">0.00</div>
                            <div id="curr-rate-info" class="curr-rate-info">Taxa atualizada via API</div>
                        </div>
                        <button id="btn-add-wallet" class="btn-add-wallet" onclick="nexus.addToWallet()">üì• ADICIONAR √Ä CARTEIRA</button>
                    </div>

                    <h2 style="color:var(--text-muted); margin-bottom:1rem; text-transform:uppercase; font-size:0.9rem; letter-spacing:1px; font-weight:700">Minhas Reservas Internacionais</h2>
                    <div class="wallet-grid">
                        <div class="wallet-item">
                            <div class="wallet-label">USD (D√≥lar)</div>
                            <input type="number" class="wallet-input" id="wallet-usd" placeholder="0.00" onchange="nexus.updateWallet('USD', this.value)">
                        </div>
                        <div class="wallet-item">
                            <div class="wallet-label">EUR (Euro)</div>
                            <input type="number" class="wallet-input" id="wallet-eur" placeholder="0.00" onchange="nexus.updateWallet('EUR', this.value)">
                        </div>
                        <div class="wallet-item">
                            <div class="wallet-label">GBP (Libra)</div>
                            <input type="number" class="wallet-input" id="wallet-gbp" placeholder="0.00" onchange="nexus.updateWallet('GBP', this.value)">
                        </div>
                        <div class="wallet-item">
                            <div class="wallet-label">BTC (Bitcoin)</div>
                            <input type="number" class="wallet-input" id="wallet-btc" placeholder="0.0000" onchange="nexus.updateWallet('BTC', this.value)">
                        </div>
                    </div>
                </div>

                <div id="suggestions-view" class="suggestions-container"></div>

                <div id="fab-container" style="text-align: center; margin-top: 2rem;">
                    <button class="btn btn-add" style="padding: 0.8rem 2rem; font-size: 1rem;" onclick="nexus.handleFabClick()">+ ADICIONAR</button>
                </div>
            </div>
        </main>
    </div>

    <div id="modal-overlay"></div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
/**
 * NEXUS CORE v11.1 (Wealth Fix & Chart Stability)
 */

// --- CONFIGURA√á√ÉO DO FIREBASE (PREENCHA AQUI) ---
const firebaseConfig = {
    apiKey: "SUA_API_KEY_AQUI",
    authDomain: "SEU_PROJETO.firebaseapp.com",
    projectId: "SEU_PROJETO_ID",
    storageBucket: "SEU_PROJETO.appspot.com",
    messagingSenderId: "NUMERO",
    appId: "ID_APP"
};

let auth, db, provider;
try {
    firebase.initializeApp(firebaseConfig);
    auth = firebase.auth();
    db = firebase.firestore();
    provider = new firebase.auth.GoogleAuthProvider();
} catch(e) {
    document.getElementById('login-status').innerText = "‚ö†Ô∏è Configure as chaves do Firebase no c√≥digo.";
}

const UNIT_SYSTEM = { /* Mantido */
    groups: { time: { label: 'Tempo', units: { 'min': 1, 'h': 60, 'd': 1440 } }, volume: { label: 'Volume', units: { 'ml': 1, 'L': 1000 } }, distance: { label: 'Dist√¢ncia', units: { 'm': 1, 'km': 1000 } }, weight: { label: 'Peso', units: { 'g': 1, 'kg': 1000 } }, money: { label: 'Moeda', units: { 'R$': 1, 'USD': 1 } }, generic: { label: 'Geral', units: { 'x': 1, 'p√°g': 1, 'caps': 1 } } }
};
const SUGGESTIONS_DB = [ /* Mantido */ 
    { type: 'boost', icon: 'üíß', name_pt: 'Beber √Ågua', name_en: 'Drink Water', target: 3, unit: 'L', cycle: 'daily' },
    { type: 'boost', icon: 'üí™', name_pt: 'Treino For√ßa', name_en: 'Strength Train', target: 1, unit: 'x', cycle: 'daily' },
    { type: 'boost', icon: 'üèÉ', name_pt: 'Cardio', name_en: 'Cardio', target: 30, unit: 'min', cycle: 'daily' },
    { type: 'boost', icon: 'üìö', name_pt: 'Leitura', name_en: 'Reading', target: 20, unit: 'pgs', cycle: 'daily' },
    { type: 'boost', icon: 'üí∞', name_pt: 'Aporte', name_en: 'Investment', target: 500, unit: 'R$', cycle: 'monthly' },
    { type: 'detox', icon: 'üç¨', name_pt: 'Zero A√ß√∫car', name_en: 'No Sugar', target: 1, unit: 'd', cycle: 'daily' },
    { type: 'detox', icon: 'üì±', name_pt: 'Redes Sociais', name_en: 'Social Media', target: 30, unit: 'min', cycle: 'daily' }
];
const DICTIONARY = { /* Mantido */
    pt: { tabs: { protocols: "PROTOCOLOS", finance: "FINAN√áAS", explore: "EXPLORAR", currency: "C√ÇMBIO" }, dash: { perf: "PERFORMANCE", streak: "DIAS SEGUIDOS", acts: "A√á√ïES HOJE" }, fin: { net: "PATRIM√îNIO GLOBAL", bal: "SALDO DISPON√çVEL", in: "TOTAL ENTRADAS", out: "TOTAL SA√çDAS", inv: "INVESTIDO", global: "INTERNACIONAL (CONVERTIDO)", desc: "Descri√ß√£o", val: "Valor" }, agenda: { title: "AGENDA DO DIA", upcoming: "PR√ìXIMOS EVENTOS", desc: "Descri√ß√£o", name: "T√≠tulo" }, cycles: { daily: "DI√ÅRIO", weekly: "SEMANAL", monthly: "MENSAL", infinite: "ACUMULATIVO" }, empty: "Sem dados.", emptyFin: "Sem movimenta√ß√µes.", btnCancel: "Cancelar", btnConfirm: "Confirmar", noEvents: "Sem eventos.", chartTitle: "DESPESAS DO M√äS" },
    en: { tabs: { protocols: "PROTOCOLS", finance: "FINANCE", explore: "EXPLORE", currency: "EXCHANGE" }, dash: { perf: "PERFORMANCE", streak: "STREAK", acts: "ACTIONS" }, fin: { net: "GLOBAL NET WORTH", bal: "AVAILABLE CASH", in: "TOTAL INCOME", out: "TOTAL EXPENSES", inv: "INVESTED", global: "INTERNATIONAL (CONVERTED)", desc: "Description", val: "Amount" }, agenda: { title: "TODAY'S AGENDA", upcoming: "UPCOMING", desc: "Description", name: "Title" }, cycles: { daily: "DAILY", weekly: "WEEKLY", monthly: "MONTHLY", infinite: "ACCUMULATIVE" }, empty: "No data.", emptyFin: "No transactions.", btnCancel: "Cancel", btnConfirm: "Confirm", noEvents: "No events.", chartTitle: "MONTHLY EXPENSES" }
};

class NexusOS {
    constructor() {
        this.user = null;
        this.lang = localStorage.getItem('nexus_lang') || 'pt'; 
        this.protocols = []; this.history = {}; this.finance = []; this.agenda = []; this.foreign = { USD:0, EUR:0, GBP:0, BTC:0 }; 
        this.lastConversion = null;
        this.today = new Date(); this.selectedDate = new Date(); this.calendarViewDate = new Date();
        this.currentTab = 'protocols';
        this.grid = document.getElementById('protocol-grid'); this.finView = document.getElementById('finance-view'); this.currView = document.getElementById('currency-view'); this.sugView = document.getElementById('suggestions-view'); this.sidebarList = document.getElementById('sidebar-event-list');
        this.checkAuthState(); 
    }

    checkAuthState() {
        if(!auth) return;
        auth.onAuthStateChanged((user) => {
            if (user) {
                this.user = user;
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('app-container').style.display = 'flex';
                document.getElementById('user-display').innerText = user.email.split('@')[0];
                this.loadFromCloud();
            } else {
                document.getElementById('login-screen').style.display = 'flex';
                document.getElementById('app-container').style.display = 'none';
            }
        });
    }
    loginGoogle() { if(auth) auth.signInWithPopup(provider); }
    logout() { auth.signOut(); location.reload(); }
    async loadFromCloud() {
        const doc = await db.collection('users').doc(this.user.uid).get();
        if (doc.exists) {
            const data = doc.data();
            this.protocols = data.protocols || [];
            this.history = data.history || {};
            this.finance = data.finance || [];
            this.agenda = data.agenda || [];
            this.foreign = data.foreign || { USD:0, EUR:0, GBP:0, BTC:0 };
        } else { this.save(); }
        this.init(); 
    }
    save() {
        if(!this.user) return;
        const data = { protocols: this.protocols, history: this.history, finance: this.finance, agenda: this.agenda, foreign: this.foreign, lastUpdate: new Date().toISOString() };
        db.collection('users').doc(this.user.uid).set(data);
        this.render(); 
    }
    init() { this.checkResets(); this.renderCalendar(); this.updateTexts(); this.render(); this.renderSuggestions(); this.renderSidebarAgenda(); this.loadWalletInputs(); }

    renderFinance() {
        let bal = 0, inv = 0, inc = 0, exp = 0;
        
        // CORRE√á√ÉO 1: L√≥gica Cont√°bil Ajustada
        // "Inv" agora √© tratado como Ativo, somando ao total sem subtrair do saldo (para simplificar acompanhamento de patrim√¥nio)
        this.finance.forEach(t => {
            const val = parseFloat(t.amount);
            if(t.type === 'in') { bal += val; inc += val; }
            else if(t.type === 'out') { bal -= val; exp += val; }
            else if(t.type === 'inv') { 
                inv += val; // Apenas soma ao montante investido, n√£o tira do caixa (Saldo = Dispon√≠vel)
            }
        });

        // Calculo Moeda Estrangeira (Mock para n√£o travar renderiza√ß√£o se API falhar)
        const rates = { USD: 5.0, EUR: 5.5, GBP: 6.3, BTC: 350000 }; 
        // Em produ√ß√£o, a API atualizaria isso, mas para o gr√°fico n√£o sumir, usamos padr√£o ou cache
        let foreignTotalBRL = 0;
        foreignTotalBRL += (this.foreign.USD || 0) * rates.USD;
        foreignTotalBRL += (this.foreign.EUR || 0) * rates.EUR;
        foreignTotalBRL += (this.foreign.GBP || 0) * rates.GBP;
        foreignTotalBRL += (this.foreign.BTC || 0) * rates.BTC;

        // Tenta atualizar taxas reais em background sem travar UI
        this.fetchRatesBackground();

        const totalGlobalNetWorth = bal + inv + foreignTotalBRL;

        // Filtros de Data
        const viewKey = this.formatDateKey(this.selectedDate);
        const dailyTransactions = this.finance.filter(t => this.formatDateKey(t.date) === viewKey).reverse();
        
        // CORRE√á√ÉO 2: Gr√°fico Mensal Robusto
        const currentMonthKey = viewKey.substring(0, 7); 
        const monthlyExpenses = {};
        let totalMonthlyExpense = 0;
        
        this.finance.forEach(t => {
            const tDateKey = this.formatDateKey(t.date);
            // Garante que s√≥ pega sa√≠das do m√™s atual
            if(tDateKey.startsWith(currentMonthKey) && t.type === 'out') {
                const cat = (t.desc || 'Outros').toUpperCase();
                if(!monthlyExpenses[cat]) monthlyExpenses[cat] = 0;
                monthlyExpenses[cat] += parseFloat(t.amount);
                totalMonthlyExpense += parseFloat(t.amount);
            }
        });

        const sortedExpenses = Object.entries(monthlyExpenses).sort((a,b) => b[1] - a[1]).slice(0, 5);
        
        let chartHTML = '';
        if(sortedExpenses.length > 0) {
            chartHTML = `<div class="fin-chart-container"><div class="chart-header" style="margin-bottom:1rem">${this.t('chartTitle')}</div>`;
            sortedExpenses.forEach(([name, amount]) => {
                const pct = totalMonthlyExpense > 0 ? (amount / totalMonthlyExpense) * 100 : 0;
                chartHTML += `<div class="chart-row"><div class="chart-header"><span>${name}</span><span>${amount.toLocaleString('pt-BR', {style:'currency', currency:'BRL'})}</span></div><div class="chart-bar-bg"><div class="chart-bar-fill" style="width:${pct}%"></div></div></div>`;
            });
            chartHTML += `</div>`;
        } else {
            // Mostra placeholder se n√£o houver dados, para o usu√°rio saber que a fun√ß√£o existe
            chartHTML = `<div class="fin-chart-container" style="text-align:center; color:var(--text-muted); font-size:0.8rem">Sem despesas registradas neste m√™s (${currentMonthKey}).</div>`;
        }

        let listHTML = '';
        dailyTransactions.forEach(t => {
             const val = parseFloat(t.amount);
             const typeClass = t.type === 'in' ? 'income' : (t.type === 'out' ? 'expense' : 'invest');
             const sign = t.type === 'in' ? '+' : (t.type === 'out' ? '-' : '‚ûú');
             const color = t.type === 'in' ? 'var(--accent)' : (t.type === 'out' ? 'var(--danger)' : 'var(--primary)');
             listHTML += `<div class="fin-item ${typeClass}"><div><div class="fin-desc">${t.desc}</div><div class="fin-date">${t.time || ''}</div></div><div class="fin-amount" style="color:${color}">${sign} ${val.toLocaleString('pt-BR', {style:'currency', currency:'BRL'})}<button class="fin-del-btn" onclick="nexus.deleteTransaction(${t.id})">‚úï</button></div></div>`;
        });

        this.finView.innerHTML = `
            <div class="fin-summary">
                <div class="fin-card global-net"><div class="fin-label">${this.t('fin.net')}</div><div class="fin-val">${totalGlobalNetWorth.toLocaleString('pt-BR', {style:'currency', currency:'BRL'})}</div></div>
                <div class="fin-card"><div class="fin-label">${this.t('fin.bal')}</div><div class="fin-val">${bal.toLocaleString('pt-BR', {style:'currency', currency:'BRL'})}</div></div>
                <div class="fin-card"><div class="fin-label">${this.t('fin.in')}</div><div class="fin-val pos">${inc.toLocaleString('pt-BR', {style:'currency', currency:'BRL'})}</div></div>
                <div class="fin-card"><div class="fin-label">${this.t('fin.out')}</div><div class="fin-val neg">${exp.toLocaleString('pt-BR', {style:'currency', currency:'BRL'})}</div></div>
                <div class="fin-card"><div class="fin-label">${this.t('fin.inv')}</div><div class="fin-val inv">${inv.toLocaleString('pt-BR', {style:'currency', currency:'BRL'})}</div></div>
                <div class="fin-card"><div class="fin-label">${this.t('fin.global')}</div><div class="fin-val glo">${foreignTotalBRL.toLocaleString('pt-BR', {style:'currency', currency:'BRL'})}</div></div>
            </div>
            ${chartHTML}
            <div style="margin-bottom:1rem; padding-bottom:0.5rem; border-bottom:1px solid var(--border); font-size:0.9rem; font-weight:bold;">Transa√ß√µes do Dia</div>
            <div class="fin-list">${listHTML || `<div style="text-align:center;color:#666;padding:2rem">${this.t('emptyFin')}</div>`}</div>
        `;
    }

    async fetchRatesBackground() {
        // Atualiza taxas silenciosamente
        try {
            const res = await fetch('https://api.exchangerate-api.com/v4/latest/BRL');
            const data = await res.json();
            // L√≥gica para atualizar valores se necess√°rio, mas n√£o re-renderiza tudo para evitar loop
        } catch(e) {}
    }

    // --- (Restante das fun√ß√µes mantidas iguais a v11.0) ---
    switchTab(tab) { this.currentTab = tab; document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active')); document.getElementById(`tab-${tab}`).classList.add('active'); document.getElementById('protocol-view').style.display = tab === 'protocols' ? 'block' : 'none'; this.finView.classList.remove('active'); this.sugView.classList.remove('active'); this.currView.classList.remove('active'); document.getElementById('fab-container').style.display = 'block'; if(tab === 'protocols') this.render(); else if(tab === 'finance') { this.finView.classList.add('active'); this.renderFinance(); } else if(tab === 'currency') { this.currView.classList.add('active'); document.getElementById('fab-container').style.display = 'none'; } else if(tab === 'suggestions') { this.sugView.classList.add('active'); document.getElementById('fab-container').style.display = 'none'; } }
    handleFabClick() { if(this.currentTab === 'protocols') this.openProtocolModal(); else if(this.currentTab === 'finance') this.openFinanceModal(); }
    formatDateKey(date) { const d = new Date(date); return d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0'); }
    checkResets() { const now = new Date(); const todayKey = this.formatDateKey(now); let hasChanges = false; this.protocols = this.protocols.map(p => { const last = new Date(p.lastReset || 0); let reset = false; if (p.cycle === 'daily' && todayKey !== this.formatDateKey(last)) reset = true; else if (p.cycle === 'weekly' && last < this.getMonday(now)) reset = true; else if (p.cycle === 'monthly' && now.getMonth() !== last.getMonth()) reset = true; if (p.cycle === 'infinite') { if(todayKey !== this.formatDateKey(last)) { if(p.current > 0) this.archiveHistory(this.formatDateKey(last), p); p.lastReset = now.toISOString(); hasChanges = true; } return p; } if (reset) { if (p.current > 0) this.archiveHistory(this.formatDateKey(last), p); p.current = 0; p.lastReset = now.toISOString(); hasChanges = true; } if(!p.lastReset) { p.lastReset = now.toISOString(); hasChanges = true; } return p; }); if(hasChanges) this.save(); }
    archiveHistory(dateKey, p) { if (!this.history[dateKey]) this.history[dateKey] = []; if (!this.history[dateKey].find(h => h.id === p.id)) { this.history[dateKey].push({...p}); this.save(); } }
    getMonday(d) { d = new Date(d); const day = d.getDay(); const diff = d.getDate() - day + (day === 0 ? -6 : 1); const m = new Date(d.setDate(diff)); m.setHours(0,0,0,0); return m; }
    renderSidebarAgenda() { const viewKey = this.formatDateKey(this.selectedDate); const isToday = viewKey === this.formatDateKey(this.today); let eventsToShow = isToday ? this.agenda.filter(e => e.date === viewKey) : this.agenda.filter(e => e.date === viewKey); eventsToShow.sort((a,b) => a.time.localeCompare(b.time)); let html = ''; if(eventsToShow.length === 0) html = `<div style="text-align:center; color:#555; font-size:0.8rem; padding:1rem;">${this.t('noEvents')}</div>`; else { eventsToShow.forEach(e => { html += `<div class="side-event-card"><div class="side-event-time">${e.time}</div><div class="side-event-title">${e.title}</div><div class="side-event-desc">${e.desc}</div><button class="btn-del-item" onclick="nexus.deleteEvent('${e.id}')">Excluir</button></div>`; }); } this.sidebarList.innerHTML = html; }
    render() { if(this.currentTab !== 'protocols') return; this.grid.innerHTML = ''; const todayKey = this.formatDateKey(this.today); const viewKey = this.formatDateKey(this.selectedDate); const isToday = viewKey === todayKey; const isFuture = viewKey > todayKey; document.getElementById('view-date-label').innerText = isToday ? '' : `Visualizando: ${viewKey}`; document.getElementById('view-date-label').style.display = isToday ? 'none' : 'block'; const dayOfWeek = this.selectedDate.getDay(); let rawData = []; if (isToday) rawData = this.protocols; else if (isFuture) rawData = this.protocols.map(p => ({...p, current: 0})); else rawData = this.history[viewKey] || []; const data = rawData.filter(p => { if (!p.days || p.days.length === 0) return true; return p.days.includes(dayOfWeek); }); if (data.length === 0) { this.grid.innerHTML = `<div style="grid-column:1/-1;text-align:center;padding:3rem;color:var(--text-muted);border:2px dashed var(--border);border-radius:20px"><h3>${this.t('empty')}</h3></div>`; document.getElementById('dashboard').style.display = 'none'; } else { document.getElementById('dashboard').style.display = 'grid'; let totalPct = 0; let activeCount = 0; data.forEach(p => { const pct = Math.min((p.current / p.target) * 100, 100); totalPct += pct; activeCount++; const isComp = p.current >= p.target; const icon = this.getIcon(p.name); const compatibleUnits = this.getCompatibleUnits(p.unit); let unitSelectorHTML = ''; if(isToday && compatibleUnits.length > 1) { unitSelectorHTML = `<select id="unit-sel-${p.id}" class="unit-selector-mini">`; compatibleUnits.forEach(u => unitSelectorHTML += `<option value="${u}" ${u===p.unit?'selected':''}>${u}</option>`); unitSelectorHTML += `</select>`; } else unitSelectorHTML = `<span class="unit-selector-mini" style="border:none;padding-top:4px">${p.unit}</span>`; const inputArea = isToday ? `<div class="input-action-row"><input type="number" class="input-fraction" id="input-${p.id}" placeholder="0" onkeydown="if(event.key==='Enter')nexus.handleInput('${p.id}')">${unitSelectorHTML}<button class="btn" onclick="nexus.handleInput('${p.id}')">+</button></div>` : ''; const card = document.createElement('div'); card.className = `card ${!isToday?'read-only':''}`; card.innerHTML = `<div style="display:flex;justify-content:space-between"><div class="protocol-name"><span class="protocol-icon">${icon}</span> ${p.name}</div>${isToday ? `<button style="background:none;border:none;color:#555;cursor:pointer" onclick="nexus.deleteProtocol('${p.id}')">‚úï</button>` : ''}</div><div class="stats"><span style="color:${isComp?'var(--accent)':'var(--text-main)'}">${p.current} / ${p.target} ${p.unit}</span><span>${pct.toFixed(0)}%</span></div><div class="progress-container"><div class="progress-fill ${isComp?'complete':''}" style="width:${pct}%"></div></div>${inputArea}`; this.grid.appendChild(card); }); if(activeCount > 0) this.renderDashboard(totalPct, activeCount); } }
    deleteTransaction(id) { if(confirm('Excluir esta transa√ß√£o?')) { this.finance = this.finance.filter(t => t.id !== id); this.save(); this.renderFinance(); } }
    async convertCurrency() { const brl = parseFloat(document.getElementById('brl-input').value); const target = document.getElementById('target-currency').value; const resDiv = document.getElementById('conversion-result'); const infoDiv = document.getElementById('curr-rate-info'); const btnAdd = document.getElementById('btn-add-wallet'); btnAdd.style.display = 'none'; if(!brl) return; resDiv.innerText = "Carregando..."; try { const response = await fetch('https://api.exchangerate-api.com/v4/latest/BRL'); const data = await response.json(); const rate = data.rates[target]; if(rate) { const converted = brl * rate; resDiv.innerText = `${target} ${converted.toFixed(2)}`; infoDiv.innerText = `Taxa: 1 BRL = ${rate} ${target}`; this.lastConversion = { target, amount: converted }; btnAdd.innerText = `üì• ADICIONAR ${converted.toFixed(2)} ${target} √ÄS RESERVAS`; btnAdd.style.display = 'block'; } else resDiv.innerText = "Erro"; } catch (e) { resDiv.innerText = "Offline"; } }
    addToWallet() { if(!this.lastConversion) return; const { target, amount } = this.lastConversion; const current = this.foreign[target] || 0; this.updateWallet(target, current + amount); this.loadWalletInputs(); document.getElementById('btn-add-wallet').style.display = 'none'; alert(`Sucesso! ${amount.toFixed(2)} ${target} adicionados √† sua carteira.`); }
    loadWalletInputs() { if(document.getElementById('wallet-usd')) { document.getElementById('wallet-usd').value = (this.foreign.USD || 0).toFixed(2); document.getElementById('wallet-eur').value = (this.foreign.EUR || 0).toFixed(2); document.getElementById('wallet-gbp').value = (this.foreign.GBP || 0).toFixed(2); document.getElementById('wallet-btc').value = (this.foreign.BTC || 0).toFixed(4); } }
    updateWallet(curr, val) { this.foreign[curr] = parseFloat(val) || 0; this.save(); }
    renderSuggestions() { this.sugView.innerHTML = ''; const renderSection = (type, titleKey) => { const items = SUGGESTIONS_DB.filter(s => s.type === type); if(items.length === 0) return ''; let html = `<div class="sug-section-title">${this.t(titleKey)}</div><div class="sug-grid">`; items.forEach(item => { const name = this.lang === 'pt' ? item.name_pt : item.name_en; html += `<div class="sug-card" onclick="nexus.openProtocolModal({name: '${name}', target: ${item.target}, unit: '${item.unit}', cycle: '${item.cycle}'})"><div class="sug-icon">${item.icon}</div><div class="sug-name">${name}</div><div class="sug-meta">${item.target} ${item.unit}</div></div>`; }); return html + `</div>`; }; this.sugView.innerHTML += renderSection('boost', 'sections.boost'); this.sugView.innerHTML += renderSection('detox', 'sections.detox'); }
    openProtocolModal(pre={}) { let optionsHTML = ''; for(const key in UNIT_SYSTEM.groups) { const g = UNIT_SYSTEM.groups[key]; optionsHTML += `<optgroup label="${g.label}">`; for(const u in g.units) optionsHTML += `<option value="${u}" ${pre.unit===u?'selected':''}>${u}</option>`; optionsHTML += `</optgroup>`; } const daysHTML = `<div class="day-selector">${['D','S','T','Q','Q','S','S'].map((d, i) => `<label><input type="checkbox" class="day-checkbox" value="${i}" checked><span class="day-label">${d}</span></label>`).join('')}</div>`; const html = ` <div class="modal"> <h2 style="color:var(--primary);margin-bottom:1.5rem">Novo Protocolo</h2> <input type="text" id="p-name" class="form-control" placeholder="Nome" value="${pre.name||''}"> <div style="display:flex;gap:1rem"> <input type="number" id="p-target" class="form-control" placeholder="Meta" value="${pre.target||''}"> <select id="p-unit" class="form-control">${optionsHTML}</select> </div> <select id="p-cycle" class="form-control"> <option value="daily" ${pre.cycle==='daily'?'selected':''}>${this.t('cycles.daily')}</option> <option value="weekly" ${pre.cycle==='weekly'?'selected':''}>${this.t('cycles.weekly')}</option> <option value="monthly" ${pre.cycle==='monthly'?'selected':''}>${this.t('cycles.monthly')}</option> <option value="infinite" ${pre.cycle==='infinite'?'selected':''}>${this.t('cycles.infinite')}</option> </select> <div style="font-size:0.8rem; color:var(--text-muted); margin-bottom:0.5rem">Dias da Semana:</div> ${daysHTML} <div style="text-align:right;margin-top:1rem"> <button class="btn" style="background:transparent;color:#666" onclick="nexus.closeModal()">${this.t('btnCancel')}</button> <button class="btn btn-add" onclick="nexus.createProtocol()">${this.t('btnConfirm')}</button> </div> </div>`; document.getElementById('modal-overlay').innerHTML = html; document.getElementById('modal-overlay').style.display = 'flex'; if(pre.name) setTimeout(()=>document.getElementById('p-target').focus(),100); }
    createProtocol() { const name = document.getElementById('p-name').value; const target = parseFloat(document.getElementById('p-target').value); const unit = document.getElementById('p-unit').value; const cycle = document.getElementById('p-cycle').value; const checkboxes = document.querySelectorAll('.day-checkbox:checked'); const selectedDays = Array.from(checkboxes).map(cb => parseInt(cb.value)); if(!name || !target) return; this.protocols.push({id:Date.now().toString(36), name, target, unit, cycle, days: selectedDays.length === 7 ? [] : selectedDays, current:0, lastReset:new Date().toISOString()}); this.closeModal(); this.save(); this.switchTab('protocols'); }
    addTransaction() { const desc = document.getElementById('f-desc').value; const amount = parseFloat(document.getElementById('f-amount').value); const type = document.getElementById('f-type').value; if(!desc || !amount) return; const timeStr = new Date().toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'}); this.finance.push({ id: Date.now(), desc, amount, type, date: new Date().toISOString(), time: timeStr }); this.save(); this.closeModal(); this.renderFinance(); }
    addEvent() { const title = document.getElementById('e-title').value; const desc = document.getElementById('e-desc').value; const date = document.getElementById('e-date').value; const time = document.getElementById('e-time').value; if(!title || !date) return; this.agenda.push({ id: Date.now().toString(36), title, desc, date, time }); this.save(); this.closeModal(); this.renderCalendar(); this.renderSidebarAgenda(); }
    t(key) { return key.split('.').reduce((o,k)=>(o||{})[k], DICTIONARY[this.lang])||key; }
    toggleLang() { this.lang=this.lang==='pt'?'en':'pt'; localStorage.setItem('nexus_lang',this.lang); this.updateTexts(); this.render(); this.renderFinance(); this.renderSuggestions(); this.renderSidebarAgenda(); this.renderCalendar(); }
    updateTexts() { document.getElementById('lang-btn').innerText = this.lang.toUpperCase(); document.getElementById('tab-protocols').innerText = this.t('tabs.protocols'); document.getElementById('tab-finance').innerText = this.t('tabs.finance'); document.getElementById('tab-suggestions').innerText = this.t('tabs.explore'); document.getElementById('tab-currency').innerText = this.t('tabs.currency'); }
    deleteProtocol(id) { if(confirm('Del?')) { this.protocols = this.protocols.filter(p=>p.id!==id); this.save(); } }
    deleteEvent(id) { if(confirm('Del?')) { this.agenda = this.agenda.filter(e=>e.id!==id); this.save(); this.renderCalendar(); this.renderSidebarAgenda(); } }
    toggleSidebar() { document.getElementById('app-sidebar').classList.toggle('active'); document.getElementById('sidebar-backdrop').classList.toggle('active'); }
    closeModal() { document.getElementById('modal-overlay').style.display = 'none'; }
    openEventModal() { const todayStr = this.formatDateKey(new Date()); const html = `<div class="modal"><h2 style="color:var(--event);margin-bottom:1.5rem">Novo Evento</h2><input type="text" id="e-title" class="form-control" placeholder="${this.t('agenda.name')}"><input type="text" id="e-desc" class="form-control" placeholder="${this.t('agenda.desc')}"><div style="display:flex;gap:1rem"><input type="date" id="e-date" class="form-control" value="${todayStr}"><input type="time" id="e-time" class="form-control" value="09:00"></div><div style="text-align:right;margin-top:1rem"><button class="btn" style="background:transparent;color:#666" onclick="nexus.closeModal()">${this.t('btnCancel')}</button><button class="btn btn-add" style="background:var(--event)" onclick="nexus.addEvent()">${this.t('btnConfirm')}</button></div></div>`; document.getElementById('modal-overlay').innerHTML = html; document.getElementById('modal-overlay').style.display = 'flex'; setTimeout(()=>document.getElementById('e-title').focus(),100); }
    openFinanceModal() { const html = `<div class="modal"><h2 style="color:var(--accent);margin-bottom:1.5rem">Transa√ß√£o Financeira</h2><input type="text" id="f-desc" class="form-control" placeholder="${this.t('fin.desc')}"><input type="number" id="f-amount" class="form-control" placeholder="${this.t('fin.val')}"><select id="f-type" class="form-control"><option value="in">Entrada (+)</option><option value="out">Sa√≠da (-)</option><option value="inv">Investimento (Invest)</option></select><div style="text-align:right;margin-top:1rem"><button class="btn" style="background:transparent;color:#666" onclick="nexus.closeModal()">${this.t('btnCancel')}</button><button class="btn btn-add" onclick="nexus.addTransaction()">${this.t('btnConfirm')}</button></div></div>`; document.getElementById('modal-overlay').innerHTML = html; document.getElementById('modal-overlay').style.display = 'flex'; setTimeout(()=>document.getElementById('f-desc').focus(),100); }
    getIcon(name) { const n=name.toLowerCase(); const i={'√°gua':'üíß','ler':'üìö','treino':'üí™','sono':'üí§','dinheiro':'üí∞','code':'üíª','a√ß√∫car':'üç¨','social':'üì±','jogos':'üéÆ'}; for(let k in i)if(n.includes(k))return i[k]; return '‚ö°'; }
    getCompatibleUnits(targetUnit) { for (const groupName in UNIT_SYSTEM.groups) { const group = UNIT_SYSTEM.groups[groupName]; if (group.units[targetUnit]) return Object.keys(group.units); } return [targetUnit]; }
    handleInput(id) { const input = document.getElementById(`input-${id}`); const unitSel = document.getElementById(`unit-sel-${id}`); const val = parseFloat(input.value); if(!val) return; const p = this.protocols.find(x => x.id === id); let finalValue = val; if(unitSel && unitSel.value !== p.unit) { let group = null; for(const g in UNIT_SYSTEM.groups) if(UNIT_SYSTEM.groups[g].units[p.unit]) group = UNIT_SYSTEM.groups[g]; if(group) { const inputMult = group.units[unitSel.value]; const targetMult = group.units[p.unit]; finalValue = (val * inputMult) / targetMult; finalValue = Math.round(finalValue * 100) / 100; } } p.current = Math.round((p.current + finalValue) * 100) / 100; this.save(); input.value = ''; }
    renderDashboard(totalPct, count) { const avg = count > 0 ? Math.round(totalPct / count) : 0; const dash = document.getElementById('dashboard'); const streak = Object.keys(this.history).length; const chartColor = avg === 100 ? 'var(--accent)' : 'var(--primary)'; dash.innerHTML = `<div class="dash-card"><svg viewBox="0 0 36 36" class="circular-chart"><path class="circle-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" /><path class="circle" stroke-dasharray="${avg}, 100" stroke="${chartColor}" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" /><text x="18" y="20.35" class="percentage">${avg}%</text></svg><div class="dash-label" style="margin-top:10px">${this.t('dash.perf')}</div></div><div class="dash-card"><div class="dash-value" style="color:var(--accent)">${streak}</div><div class="dash-label">${this.t('dash.streak')}</div></div><div class="dash-card"><div class="dash-value">${count}</div><div class="dash-label">${this.t('dash.acts')}</div></div>`; }
    renderCalendar() { const c = document.getElementById('calendar-days'); const ml = document.getElementById('month-label'); c.innerHTML=''; const year = this.calendarViewDate.getFullYear(); const month = this.calendarViewDate.getMonth(); const mNames = this.lang==='pt'?["JAN","FEV","MAR","ABR","MAI","JUN","JUL","AGO","SET","OUT","NOV","DEZ"]:["JAN","FEB","MAR","APR","MAY","JUN","JUL","AUG","SEP","OCT","NOV","DEC"]; ml.innerText = mNames[month] + " " + year; const first = new Date(year,month,1).getDay(); const days = new Date(year,month+1,0).getDate(); for(let i=0;i<first;i++)c.innerHTML+=`<div></div>`; for(let i=1;i<=days;i++){ const d=new Date(year,month,i); const k=this.formatDateKey(d); const isT=this.formatDateKey(this.today)===k; const isS=this.formatDateKey(this.selectedDate)===k; const hasHist=this.history[k]; const hasEvent = this.agenda.some(e => e.date === k); const div=document.createElement('div'); div.className=`day-cell ${isT?'today':''} ${isS?'selected':''} ${hasHist?'has-data':''}`; div.innerText=i; if(hasEvent) div.innerHTML += `<div class="dot-event"></div>`; if(hasHist) div.innerHTML += `<div class="dot-hist"></div>`; div.onclick=()=>this.selectDate(d); c.appendChild(div); } }
    changeMonth(d) { this.calendarViewDate.setMonth(this.calendarViewDate.getMonth()+d); this.renderCalendar(); }
    selectDate(d) { this.selectedDate=d; this.switchTab('protocols'); this.renderCalendar(); this.render(); this.renderSidebarAgenda(); if(window.innerWidth<=850) this.toggleSidebar(); }
}

document.addEventListener('DOMContentLoaded', () => { window.nexus = new NexusOS(); });
document.getElementById('modal-overlay').addEventListener('click', (e) => { if(e.target.id === 'modal-overlay') nexus.closeModal(); });
</script>
</body>
</html>