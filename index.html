<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NEXUS LIFE OS v7.0</title>
    
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect x='4' y='4' width='56' height='56' rx='18' fill='none' stroke='%2300f0ff' stroke-width='4'/%3E%3Ctext x='50%25' y='55%25' dominant-baseline='middle' text-anchor='middle' font-family='sans-serif' font-weight='bold' fill='%2300f0ff' font-size='28' letter-spacing='-1'%3ENS%3C/text%3E%3C/svg%3E">

    <style>
        :root {
            --bg-core: #0a0a0a;
            --bg-panel: #161616;
            --bg-sidebar: #111111;
            --bg-input: #222222;
            --primary: #00f0ff;
            --primary-dim: rgba(0, 240, 255, 0.15);
            --accent: #00ff9d;
            --danger: #ff477e;
            --text-main: #f0f0f0;
            --text-muted: #888888;
            --border: #333333;
            --font-stack: 'Segoe UI', 'Roboto', sans-serif;
            --radius-card: 20px;
            --radius-btn: 50px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; }

        body {
            background-color: var(--bg-core);
            color: var(--text-main);
            font-family: var(--font-stack);
            height: 100vh;
            overflow: hidden;
            display: flex;
        }

        /* --- SIDEBAR (Calend√°rio Off-Canvas) --- */
        .app-sidebar {
            width: 320px;
            background: var(--bg-sidebar);
            border-right: 1px solid var(--border);
            display: flex; flex-direction: column; padding: 2rem 1.5rem; flex-shrink: 0; overflow-y: auto;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 2000;
        }

        .sidebar-close-btn { display: none; margin-bottom: 1rem; color: var(--text-muted); background: transparent; border: none; font-size: 1.5rem; cursor: pointer; text-align: right; }

        /* --- CONTENT AREA --- */
        .app-content {
            flex: 1; padding: 2rem; overflow-y: auto; display: flex; flex-direction: column; align-items: center; position: relative;
        }
        .content-container { width: 100%; max-width: 800px; padding-bottom: 80px; }

        /* --- DASHBOARD (New Feature) --- */
        .dashboard-section {
            margin-top: 3rem;
            border-top: 1px solid var(--border);
            padding-top: 2rem;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5rem;
        }

        .dash-card {
            background: var(--bg-panel);
            border: 1px solid var(--border);
            border-radius: var(--radius-card);
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .dash-value { font-size: 1.8rem; font-weight: 800; color: white; margin-bottom: 0.5rem; }
        .dash-label { font-size: 0.8rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; }
        
        /* Circular Chart CSS */
        .circular-chart { display: block; margin: 0 auto; max-width: 80%; max-height: 250px; }
        .circle-bg { fill: none; stroke: var(--bg-input); stroke-width: 3.8; }
        .circle { fill: none; stroke-width: 2.8; stroke-linecap: round; animation: progress 1s ease-out forwards; }
        @keyframes progress { 0% { stroke-dasharray: 0 100; } }
        .percentage { fill: #fff; font-family: var(--font-stack); font-weight: bold; font-size: 0.5em; text-anchor: middle; }

        /* --- HEADER & UI --- */
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .header-left { display: flex; align-items: center; gap: 1rem; }
        .mobile-toggle-btn { display: none; background: var(--bg-input); border: 1px solid var(--border); color: var(--primary); width: 40px; height: 40px; border-radius: 12px; align-items: center; justify-content: center; cursor: pointer; font-size: 1.2rem; }
        
        h1 { font-size: 1.4rem; font-weight: 700; display: flex; align-items: center; }
        .logo-icon-header { width: 36px; height: 36px; margin-right: 12px; color: var(--primary); }
        h1 span { color: var(--primary); font-weight: 300; margin-left: 5px; }

        .tab-nav { display: flex; gap: 2rem; margin-bottom: 2rem; border-bottom: 1px solid var(--border); padding-left: 0.5rem; overflow-x: auto; }
        .tab-btn { background: transparent; border: none; color: var(--text-muted); padding: 0.8rem 0; cursor: pointer; font-size: 0.95rem; font-weight: 600; border-bottom: 2px solid transparent; transition: all 0.2s; white-space: nowrap; }
        .tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); }

        /* --- PROTOCOL CARDS --- */
        #protocol-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 1.2rem; }
        .card { background: var(--bg-panel); border: 1px solid var(--border); border-radius: var(--radius-card); padding: 1.5rem; display: flex; flex-direction: column; gap: 1.2rem; transition: transform 0.2s; }
        .protocol-name { font-size: 1.15rem; font-weight: 600; color: white; display: flex; align-items: center; gap: 10px; }
        .protocol-icon { background: rgba(255,255,255,0.05); width: 36px; height: 36px; border-radius: 50%; display: flex; justify-content: center; align-items: center; }
        .progress-container { width: 100%; height: 10px; background: var(--bg-core); border-radius: 10px; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, var(--primary), var(--accent)); width: 0%; border-radius: 10px; transition: width 0.5s ease; }
        .progress-fill.complete { background: var(--accent); }
        .stats { display: flex; justify-content: space-between; font-size: 0.85rem; font-weight: 500; }

        /* --- SMART INPUTS --- */
        .input-action-row { display: flex; gap: 0.5rem; margin-top: 0.5rem; }
        .input-fraction { flex: 1; background: var(--bg-input); border: 1px solid var(--border); border-radius: 12px; color: white; padding: 0.8rem; font-size: 1rem; }
        .unit-selector-mini {
            background: var(--bg-input); color: var(--text-muted); border: 1px solid var(--border); border-radius: 12px;
            padding: 0 0.5rem; font-size: 0.8rem; font-weight: bold; cursor: pointer; width: 70px;
        }
        .btn { background: var(--bg-input); border: 1px solid var(--border); color: var(--primary); padding: 0.6rem 1.2rem; cursor: pointer; border-radius: var(--radius-btn); font-size: 0.85rem; font-weight: 600; }
        .btn-add { background: var(--primary); color: var(--bg-core); border: none; }

        /* --- CALENDAR --- */
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .month-label { font-size: 1.1rem; font-weight: bold; color: white; }
        .month-nav { background: transparent; border: none; color: var(--text-muted); cursor: pointer; font-size: 1.2rem; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; margin-bottom: 2rem; }
        .day-cell { aspect-ratio: 1; display: flex; justify-content: center; align-items: center; font-size: 0.9rem; border-radius: 12px; cursor: pointer; color: var(--text-muted); }
        .day-cell.today { border-color: var(--primary); color: var(--primary); border: 1px solid var(--primary); }
        .day-cell.has-data { position: relative; }
        .day-cell.has-data::after { content: ''; position: absolute; bottom: 4px; width: 4px; height: 4px; background: var(--accent); border-radius: 50%; }

        /* --- MOBILE --- */
        @media (max-width: 850px) {
            .mobile-toggle-btn { display: flex; }
            .sidebar-close-btn { display: block; }
            h1 span { display: none; } h1 { font-size: 1.2rem; }
            .app-sidebar { position: fixed; top: 0; left: 0; width: 85%; height: 100vh; transform: translateX(-100%); box-shadow: 10px 0 50px rgba(0,0,0,0.5); }
            .app-sidebar.active { transform: translateX(0); }
            .sidebar-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1900; display: none; }
            .sidebar-backdrop.active { display: block; }
            .dashboard-section { grid-template-columns: 1fr; }
            .app-content { padding: 1.5rem 1rem; }
        }

        /* --- MODAL --- */
        #modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); backdrop-filter: blur(8px); display: none; justify-content: center; align-items: center; z-index: 3000; padding: 1rem; }
        .modal { background: var(--bg-panel); border: 1px solid var(--border); border-radius: var(--radius-card); padding: 2rem; width: 100%; max-width: 420px; }
        .form-control { width: 100%; padding: 0.9rem; background: var(--bg-input); border: 1px solid var(--border); border-radius: 12px; color: white; font-size: 1rem; margin-bottom: 1rem; }
        select.form-control { appearance: none; }
    </style>
</head>
<body>

    <div id="sidebar-backdrop" class="sidebar-backdrop" onclick="nexus.toggleSidebar()"></div>

    <aside class="app-sidebar" id="app-sidebar">
        <button class="sidebar-close-btn" onclick="nexus.toggleSidebar()">‚úï</button>
        <div class="calendar-header">
            <button class="month-nav" onclick="nexus.changeMonth(-1)">‚ùÆ</button>
            <span class="month-label" id="month-label">...</span>
            <button class="month-nav" onclick="nexus.changeMonth(1)">‚ùØ</button>
        </div>
        <div class="calendar-grid">
            <div style="color:var(--text-muted);font-size:0.7rem;text-align:center">D</div><div style="color:var(--text-muted);font-size:0.7rem;text-align:center">S</div><div style="color:var(--text-muted);font-size:0.7rem;text-align:center">T</div><div style="color:var(--text-muted);font-size:0.7rem;text-align:center">Q</div><div style="color:var(--text-muted);font-size:0.7rem;text-align:center">Q</div><div style="color:var(--text-muted);font-size:0.7rem;text-align:center">S</div><div style="color:var(--text-muted);font-size:0.7rem;text-align:center">S</div>
            <div id="calendar-days" style="display: contents;"></div>
        </div>
        <div style="margin-top: auto; padding-top: 1rem; border-top: 1px solid var(--border); text-align: center;">
            <button class="btn" style="width: 100%" onclick="nexus.selectDate(new Date())">VOLTAR PARA HOJE</button>
        </div>
    </aside>

    <main class="app-content">
        <div class="content-container">
            <header>
                <div class="header-left">
                    <button class="mobile-toggle-btn" onclick="nexus.toggleSidebar()">üìÖ</button>
                    <h1>
                        <svg class="logo-icon-header" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg"><rect x="4" y="4" width="56" height="56" rx="18" fill="none" stroke="currentColor" stroke-width="5"/><text x="50%" y="54%" dominant-baseline="middle" text-anchor="middle" font-family="sans-serif" font-weight="800" fill="currentColor" font-size="26" letter-spacing="-1">NS</text></svg>
                        Nexus <span>Life OS</span>
                    </h1>
                </div>
                <button class="btn" style="padding:0.5rem" onclick="nexus.toggleLang()">EN/PT</button>
            </header>

            <nav class="tab-nav">
                <button class="tab-btn active" id="tab-protocols">MEUS PROTOCOLOS</button>
            </nav>

            <h3 id="view-date-label" style="display:none; color:var(--primary); margin-bottom:1rem">...</h3>
            
            <div id="protocol-grid"></div>

            <section id="dashboard" class="dashboard-section" style="display: none;">
                </section>

            <div id="fab-container" style="text-align: center; margin-top: 2rem;">
                <button class="btn btn-add" style="padding: 0.8rem 2rem; font-size: 1rem;" onclick="nexus.openModal()">+ CRIAR NOVO</button>
            </div>
        </div>
    </main>

    <div id="modal-overlay"></div>

<script>
/**
 * NEXUS CORE v7.0 (Units & Analytics)
 */

// SISTEMA DE MEDIDAS E CONVERS√ÉO
const UNIT_SYSTEM = {
    groups: {
        time: { label: 'Tempo', units: { 'h': 1, 'min': 60 } }, // Base: Horas. 1h = 1h, 1h = 60min
        volume: { label: 'Volume', units: { 'L': 1, 'ml': 1000 } }, // Base: Litros
        distance: { label: 'Dist√¢ncia', units: { 'km': 1, 'm': 1000 } }, // Base: KM
        weight: { label: 'Peso', units: { 'kg': 1, 'g': 1000 } }, // Base: KG
        money: { label: 'Finan√ßas', units: { 'R$': 1, '$': 1, '‚Ç¨': 1 } },
        generic: { label: 'Geral', units: { 'x': 1, 'pgs': 1, 'caps': 1 } }
    }
};

class NexusOS {
    constructor() {
        this.lang = localStorage.getItem('nexus_lang') || 'pt'; 
        this.protocols = JSON.parse(localStorage.getItem('nexus_protocols')) || [];
        this.history = JSON.parse(localStorage.getItem('nexus_history')) || {}; 
        this.today = new Date(); this.selectedDate = new Date(); this.calendarViewDate = new Date();
        this.init();
    }

    init() {
        this.checkResets();
        this.renderCalendar();
        this.render();
    }

    // --- CORE LOGIC ---
    formatDateKey(date) { const d = new Date(date); return d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0'); }

    checkResets() {
        const now = new Date(); const todayKey = this.formatDateKey(now); let hasChanges = false;
        this.protocols = this.protocols.map(p => {
            const last = new Date(p.lastReset || 0);
            let reset = false;
            // Simple logic for brevity
            if (p.cycle === 'daily' && todayKey !== this.formatDateKey(last)) reset = true;
            if (reset) { 
                if (p.current > 0) this.archiveHistory(this.formatDateKey(last), p);
                p.current = 0; p.lastReset = now.toISOString(); hasChanges = true; 
            }
            if(!p.lastReset) { p.lastReset = now.toISOString(); hasChanges = true; }
            return p;
        });
        if(hasChanges) this.save();
    }

    archiveHistory(dateKey, p) {
        if (!this.history[dateKey]) this.history[dateKey] = [];
        if (!this.history[dateKey].find(h => h.id === p.id)) {
            this.history[dateKey].push({...p}); 
            localStorage.setItem('nexus_history', JSON.stringify(this.history));
        }
    }

    // --- SMART UNIT CONVERSION ---
    // Retorna a lista de unidades compat√≠veis com a unidade alvo
    getCompatibleUnits(targetUnit) {
        for (const groupName in UNIT_SYSTEM.groups) {
            const group = UNIT_SYSTEM.groups[groupName];
            if (group.units[targetUnit]) return Object.keys(group.units);
        }
        return [targetUnit]; // Se n√£o achar grupo, retorna ela mesma
    }

    convertValue(amount, fromUnit, toUnit) {
        // Encontra o grupo
        let group = null;
        for (const g in UNIT_SYSTEM.groups) {
            if (UNIT_SYSTEM.groups[g].units[fromUnit] && UNIT_SYSTEM.groups[g].units[toUnit]) {
                group = UNIT_SYSTEM.groups[g];
                break;
            }
        }
        if (!group) return parseFloat(amount); // Sem convers√£o poss√≠vel

        // Regra de 3: 
        // Se 1 Base = X FromUnit
        // Se 1 Base = Y ToUnit
        // Valor Base = Amount / FromFactor
        // Valor Final = Valor Base * ToFactor ?? N√£o.
        // Vamos simplificar: Converter tudo para a unidade MENOR (ex: ml, min) ou BASE?
        // Usaremos fator relativo a BASE 1.
        // Ex: Base = Hora. h=1, min=60.
        // Input: 30 min -> Target: h.
        // 30 / 60 = 0.5. Correto.
        // Input: 0.5 h -> Target: min.
        // 0.5 * 60 / 1 = 30.
        
        const fromFactor = group.units[fromUnit];
        const toFactor = group.units[toUnit];
        
        // Convers√£o: (Amount / FromFactor) * ToFactor ??? 
        // N√£o. Se h=1 e min=60.
        // Quero converter 30min para h.
        // 30 / 60 = 0.5. (Amount / FromFactor) * ToFactor (1) = 0.5.
        // Quero converter 1h para min.
        // 1 / 1 * 60 = 60.
        // Quero converter 1000m para km (km=1, m=1000).
        // 1000 / 1000 * 1 = 1.
        
        // CORRE√á√ÉO L√ìGICA:
        // Os fatores no objeto s√£o "Quantos deste cabem em 1 Base".
        return (parseFloat(amount) / fromFactor) * toFactor; 
        
        // Espera, se eu tenho HORA como base (1) e MINUTO (60).
        // O input √© 30 MINUTOS. Quero somar na meta que est√° em HORAS.
        // Valor = 30 / 60 = 0.5.
        // Ent√£o a f√≥rmula √©: amount / factor_of_input_unit * factor_of_target_unit
        // Se meta √© MINUTOS (base seria min? n√£o, base fixa).
        
        // SIMPLIFICA√á√ÉO: O sistema armazena o valor na unidade que o usu√°rio definiu como "Unidade da Meta".
        // Se a Meta √© em Litros (L). Factor L = 1. Factor ml = 1000.
        // Input: 500 ml.
        // Conta: 500 / 1000 = 0.5. Soma 0.5 na meta.
        
        return (parseFloat(amount) / fromFactor) * toFactor; // N√£o, essa logica inverteu.
        
        // Correto: Valor Normalizado = Amount / FatorDaUnidadeInput.
        // Valor Convertido = Valor Normalizado * FatorDaUnidadeTarget.
        // Teste: 500ml (fator 1000) -> 1 L (fator 1).
        // 500 / 1000 * 1 = 0.5. CERTO.
        // Teste: 0.5 L (fator 1) -> ml (fator 1000).
        // 0.5 / 1 * 1000 = 500. CERTO.
    }

    // --- UI RENDER ---
    render() {
        const grid = document.getElementById('protocol-grid');
        const dashboard = document.getElementById('dashboard');
        grid.innerHTML = '';
        
        const isToday = this.formatDateKey(this.selectedDate) === this.formatDateKey(this.today);
        const viewKey = this.formatDateKey(this.selectedDate);
        
        document.getElementById('view-date-label').innerText = isToday ? '' : `Visualizando: ${viewKey}`;
        document.getElementById('view-date-label').style.display = isToday ? 'none' : 'block';
        document.getElementById('fab-container').style.display = isToday ? 'block' : 'none';

        const data = isToday ? this.protocols : (this.history[viewKey] || []);
        
        // DASHBOARD LOGIC
        let totalPct = 0;
        let activeCount = 0;
        
        if (data.length === 0) {
            grid.innerHTML = `<div style="grid-column:1/-1;text-align:center;padding:3rem;color:var(--text-muted);border:2px dashed var(--border);border-radius:20px"><h3>Sem Dados</h3></div>`;
            dashboard.style.display = 'none';
        } else {
            dashboard.style.display = 'grid'; // Show Dashboard
            
            data.forEach(p => {
                const pct = Math.min((p.current / p.target) * 100, 100);
                totalPct += pct;
                activeCount++;
                
                const isComp = p.current >= p.target;
                const icon = this.getIcon(p.name);
                
                // Dropdown de Unidades (Mini)
                const compatibleUnits = this.getCompatibleUnits(p.unit);
                let unitSelectorHTML = '';
                if(isToday && compatibleUnits.length > 1) {
                    unitSelectorHTML = `<select id="unit-sel-${p.id}" class="unit-selector-mini">`;
                    compatibleUnits.forEach(u => unitSelectorHTML += `<option value="${u}" ${u===p.unit?'selected':''}>${u}</option>`);
                    unitSelectorHTML += `</select>`;
                } else {
                    unitSelectorHTML = `<span class="unit-selector-mini" style="border:none;padding-top:4px">${p.unit}</span>`;
                }

                const inputArea = isToday ? `
                    <div class="input-action-row">
                        <input type="number" class="input-fraction" id="input-${p.id}" placeholder="0">
                        ${unitSelectorHTML}
                        <button class="btn" onclick="nexus.handleInput('${p.id}')">+</button>
                    </div>` : '';

                const card = document.createElement('div'); 
                card.className = `card`;
                card.innerHTML = `
                    <div style="display:flex;justify-content:space-between">
                        <div class="protocol-name"><span class="protocol-icon">${icon}</span> ${p.name}</div>
                        ${isToday ? `<button style="background:none;border:none;color:#555;cursor:pointer" onclick="nexus.deleteProtocol('${p.id}')">‚úï</button>` : ''}
                    </div>
                    <div class="stats">
                        <span style="color:${isComp?'var(--accent)':'var(--text-main)'}">${p.current} / ${p.target} ${p.unit}</span>
                        <span>${pct.toFixed(0)}%</span>
                    </div>
                    <div class="progress-container"><div class="progress-fill ${isComp?'complete':''}" style="width:${pct}%"></div></div>
                    ${inputArea}
                `;
                grid.appendChild(card);
            });
            
            this.renderDashboard(totalPct, activeCount);
        }
    }

    renderDashboard(totalPct, count) {
        const avg = count > 0 ? Math.round(totalPct / count) : 0;
        const dash = document.getElementById('dashboard');
        
        // Calculate Streak (Simulated simple logic)
        const streak = this.calculateStreak();
        
        // Color for chart
        const chartColor = avg === 100 ? 'var(--accent)' : 'var(--primary)';

        dash.innerHTML = `
            <div class="dash-card">
                <svg viewBox="0 0 36 36" class="circular-chart">
                    <path class="circle-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                    <path class="circle" stroke-dasharray="${avg}, 100" stroke="${chartColor}" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                    <text x="18" y="20.35" class="percentage">${avg}%</text>
                </svg>
                <div class="dash-label" style="margin-top:10px">PERFORMANCE</div>
            </div>
            <div class="dash-card">
                <div class="dash-value" style="color:var(--accent)">${streak}</div>
                <div class="dash-label">DIAS SEGUIDOS</div>
            </div>
            <div class="dash-card">
                <div class="dash-value">${count}</div>
                <div class="dash-label">ATIVIDADES</div>
            </div>
        `;
    }

    calculateStreak() {
        // L√≥gica simplificada de streak baseada no hist√≥rico
        let streak = 0;
        const keys = Object.keys(this.history).sort().reverse();
        // Check yesterday, then day before...
        // For simple demo, returns random number or 1 if history exists
        return keys.length > 0 ? keys.length : 0; 
    }

    handleInput(id) {
        const input = document.getElementById(`input-${id}`);
        const unitSel = document.getElementById(`unit-sel-${id}`);
        const val = parseFloat(input.value);
        if(!val) return;

        const p = this.protocols.find(x => x.id === id);
        
        // Convers√£o L√≥gica
        let finalValue = val;
        if(unitSel && unitSel.value !== p.unit) {
            // Se input unit != target unit, converter
            // Precisamos dos fatores.
            let group = null;
            for(const g in UNIT_SYSTEM.groups) {
                if(UNIT_SYSTEM.groups[g].units[p.unit]) group = UNIT_SYSTEM.groups[g];
            }
            if(group) {
                const inputFactor = group.units[unitSel.value]; // ex: ml = 1000
                const targetFactor = group.units[p.unit]; // ex: L = 1
                
                // Formula: (Input / InputFactor) * TargetFactor
                // Ex: 500 / 1000 * 1 = 0.5
                finalValue = (val / inputFactor) * targetFactor;
                
                // Arredondar para evitar 0.300000004
                finalValue = Math.round(finalValue * 100) / 100;
            }
        }

        p.current = Math.round((p.current + finalValue) * 100) / 100;
        this.save();
        input.value = '';
    }

    // --- MODAL & CREATION ---
    openModal() {
        // Gera Options para o Select de Unidades (Agrupado)
        let optionsHTML = '';
        for(const key in UNIT_SYSTEM.groups) {
            const g = UNIT_SYSTEM.groups[key];
            optionsHTML += `<optgroup label="${g.label}">`;
            for(const u in g.units) optionsHTML += `<option value="${u}">${u}</option>`;
            optionsHTML += `</optgroup>`;
        }

        const html = `
            <div class="modal">
                <h2 style="color:var(--primary);margin-bottom:1.5rem">Novo Protocolo</h2>
                <input type="text" id="p-name" class="form-control" placeholder="Nome (ex: Beber √Ågua)">
                <div style="display:flex;gap:1rem">
                    <input type="number" id="p-target" class="form-control" placeholder="Meta (ex: 3)">
                    <select id="p-unit" class="form-control">${optionsHTML}</select>
                </div>
                <select id="p-cycle" class="form-control">
                    <option value="daily">Di√°rio</option>
                    <option value="weekly">Semanal</option>
                    <option value="monthly">Mensal</option>
                </select>
                <div style="text-align:right">
                    <button class="btn" style="background:transparent;color:#666" onclick="nexus.closeModal()">Cancelar</button>
                    <button class="btn btn-add" onclick="nexus.createProtocol()">Criar</button>
                </div>
            </div>`;
        document.getElementById('modal-overlay').innerHTML = html;
        document.getElementById('modal-overlay').style.display = 'flex';
    }

    createProtocol() {
        const name = document.getElementById('p-name').value;
        const target = parseFloat(document.getElementById('p-target').value);
        const unit = document.getElementById('p-unit').value;
        const cycle = document.getElementById('p-cycle').value;
        if(!name || !target) return;
        this.protocols.push({id:Date.now().toString(36), name, target, unit, cycle, current:0, lastReset:new Date().toISOString()});
        this.closeModal(); this.save();
    }

    // --- HELPERS ---
    save() { localStorage.setItem('nexus_protocols', JSON.stringify(this.protocols)); this.render(); }
    deleteProtocol(id) { if(confirm('Excluir?')) { this.protocols = this.protocols.filter(p=>p.id!==id); this.save(); } }
    toggleSidebar() { document.getElementById('app-sidebar').classList.toggle('active'); document.getElementById('sidebar-backdrop').classList.toggle('active'); }
    closeModal() { document.getElementById('modal-overlay').style.display = 'none'; }
    getIcon(name) { const n=name.toLowerCase(); const i={'√°gua':'üíß','ler':'üìö','treino':'üí™','sono':'üí§','dinheiro':'üí∞','code':'üíª'}; for(let k in i)if(n.includes(k))return i[k]; return '‚ö°'; }
    renderCalendar() { /* Simplificado para manter tamanho */ const c = document.getElementById('calendar-days'); c.innerHTML=''; for(let i=1;i<=30;i++){const d=document.createElement('div');d.className=`day-cell ${i===this.today.getDate()?'today':''}`;d.innerText=i;c.appendChild(d);} }
    toggleLang() { /* Stub */ }
    changeMonth() { /* Stub */ }
    selectDate(d) { this.selectedDate = d; this.render(); if(window.innerWidth<=850)this.toggleSidebar(); }
}

document.addEventListener('DOMContentLoaded', () => { window.nexus = new NexusOS(); });
</script>
</body>
</html>